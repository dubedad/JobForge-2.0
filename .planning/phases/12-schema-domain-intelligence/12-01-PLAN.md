---
phase: 12-schema-domain-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/jobforge/catalog/enrich.py
  - data/catalog/tables/cops_employment.json
  - data/catalog/tables/cops_employment_growth.json
  - data/catalog/tables/cops_immigration.json
  - data/catalog/tables/cops_other_replacement.json
  - data/catalog/tables/cops_other_seekers.json
  - data/catalog/tables/cops_retirement_rates.json
  - data/catalog/tables/cops_retirements.json
  - data/catalog/tables/cops_school_leavers.json
  - data/catalog/tables/dim_noc.json
autonomous: true

must_haves:
  truths:
    - "Catalog JSON files have semantic column descriptions (not 'Column of type VARCHAR')"
    - "COPS tables have workforce_dynamic field indicating demand or supply"
    - "Year columns have descriptions explaining what the value represents"
  artifacts:
    - path: "src/jobforge/catalog/enrich.py"
      provides: "Catalog enrichment script"
      min_lines: 80
    - path: "data/catalog/tables/cops_employment.json"
      provides: "Enriched employment table metadata"
      contains: "workforce_dynamic"
  key_links:
    - from: "src/jobforge/catalog/enrich.py"
      to: "data/catalog/tables/*.json"
      via: "writes enriched metadata"
      pattern: "json.dump"
---

<objective>
Enrich catalog JSON files with semantic column descriptions and workforce_dynamic classification

Purpose: Provide rich metadata foundation for enhanced DDL generation (Plan 12-02)
Output: Updated catalog JSON files with meaningful descriptions and domain semantics
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-schema-domain-intelligence/12-CONTEXT.md
@.planning/phases/12-schema-domain-intelligence/12-RESEARCH.md
@src/jobforge/pipeline/models.py
@data/catalog/tables/cops_employment.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create catalog enrichment module</name>
  <files>src/jobforge/catalog/enrich.py</files>
  <action>
Create `src/jobforge/catalog/enrich.py` with an `enrich_catalog()` function that:

1. Define COPS column descriptions dictionary:
   - year columns (2023-2033): "Projected {metric} for {year}" where metric varies by table
   - unit_group_id: "Foreign key to dim_noc.unit_group_id - 5-digit NOC 2021 code"
   - code: "NOC code (may include aggregate codes like TEER_0)"
   - occupation_name_en: "English occupation name from COPS source"
   - occupation_name_fr: "French occupation name from COPS source"

2. Define workforce_dynamic mapping (from CONTEXT.md):
   - DEMAND: cops_employment, cops_employment_growth, cops_retirements, cops_retirement_rates, cops_other_replacement
   - SUPPLY: cops_immigration, cops_school_leavers, cops_other_seekers

3. Define table descriptions for COPS tables:
   - cops_employment: "Employment counts by NOC occupation - base employment projection"
   - cops_employment_growth: "Annual employment growth rates by occupation"
   - cops_retirements: "Projected retirement counts by occupation"
   - cops_retirement_rates: "Annual retirement rates by occupation"
   - cops_other_replacement: "Other replacement demand by occupation"
   - cops_immigration: "Immigrant workers entering occupations"
   - cops_school_leavers: "School leavers entering workforce by occupation"
   - cops_other_seekers: "Other job seekers entering workforce by occupation"

4. Define dim_noc column descriptions:
   - unit_group_id: "Primary key - 5-digit NOC 2021 code, zero-padded (e.g., 00010, 21232)"
   - noc_code: "NOC code without zero-padding"
   - class_title: "Official NOC occupation title"
   - class_definition: "Full text description of the occupation"
   - hierarchical_structure: "Level in NOC hierarchy"

5. Function `enrich_catalog(catalog_path: Path | None = None) -> dict[str, int]`:
   - Default catalog_path to `data/catalog/tables`
   - Iterate through all JSON files
   - For each file, load JSON and update:
     - `description` field at table level (if in mapping)
     - `workforce_dynamic` field (if COPS table, add to root)
     - Column `description` fields (if in mapping)
   - Write back modified JSON with `indent=2`
   - Return dict with counts: {"tables_updated": N, "columns_enriched": M}

6. Add `if __name__ == "__main__":` block that runs enrichment and prints results.

Use pathlib for paths. Preserve all existing fields when updating JSON.
  </action>
  <verify>
    python -c "from jobforge.catalog.enrich import enrich_catalog; print(enrich_catalog())"
  </verify>
  <done>
    Module exists, function runs without error, returns counts dict
  </done>
</task>

<task type="auto">
  <name>Task 2: Run enrichment and verify catalog updates</name>
  <files>data/catalog/tables/*.json</files>
  <action>
1. Run the enrichment script:
   ```
   python -m jobforge.catalog.enrich
   ```

2. Verify results by spot-checking:
   - `cops_employment.json`: Should have `workforce_dynamic: "demand"` at root, year columns should have descriptions like "Projected employment count for 2025"
   - `cops_immigration.json`: Should have `workforce_dynamic: "supply"`, year columns with "Projected immigrant workers for {year}"
   - `dim_noc.json`: Should have enriched column descriptions

3. If any issues, fix the enrichment script and re-run.

4. Create `__init__.py` in `src/jobforge/catalog/` if it does not exist (may need to create directory too).
  </action>
  <verify>
    python -c "import json; d=json.load(open('data/catalog/tables/cops_employment.json')); print('workforce_dynamic:', d.get('workforce_dynamic')); print('2025 desc:', [c for c in d['columns'] if c['name']=='2025'][0]['description'])"
  </verify>
  <done>
    - cops_employment.json has workforce_dynamic="demand"
    - Year column descriptions are not "Column of type VARCHAR"
    - dim_noc columns have meaningful descriptions
  </done>
</task>

<task type="auto">
  <name>Task 3: Add enrichment tests</name>
  <files>tests/test_catalog_enrich.py</files>
  <action>
Create `tests/test_catalog_enrich.py` with tests:

1. `test_enrich_catalog_returns_counts()`:
   - Call `enrich_catalog()` with temp directory containing sample JSON
   - Assert returns dict with tables_updated and columns_enriched keys
   - Assert counts are non-negative integers

2. `test_enrichment_adds_workforce_dynamic()`:
   - Create temp cops_employment.json without workforce_dynamic
   - Run enrichment
   - Load result and assert workforce_dynamic == "demand"

3. `test_enrichment_updates_column_descriptions()`:
   - Create temp JSON with column description "Column of type VARCHAR"
   - Run enrichment
   - Assert column description is now semantic (not generic)

4. `test_enrichment_preserves_existing_fields()`:
   - Create temp JSON with custom field like `custom_field: "preserve_me"`
   - Run enrichment
   - Assert custom_field still present and unchanged

Use `tmp_path` fixture from pytest. Import from `jobforge.catalog.enrich`.
  </action>
  <verify>
    pytest tests/test_catalog_enrich.py -v
  </verify>
  <done>
    All tests pass, enrichment is tested for correctness and field preservation
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. Run enrichment verification:
   ```
   python -c "import json; d=json.load(open('data/catalog/tables/cops_employment.json')); assert d.get('workforce_dynamic') == 'demand', 'workforce_dynamic missing'; assert 'employment' in d['columns'][4]['description'].lower(), 'year desc not enriched'"
   ```

2. Run tests:
   ```
   pytest tests/test_catalog_enrich.py -v
   ```

3. Spot check supply table:
   ```
   python -c "import json; d=json.load(open('data/catalog/tables/cops_immigration.json')); print('workforce_dynamic:', d.get('workforce_dynamic'))"
   ```
   Should output: `workforce_dynamic: supply`
</verification>

<success_criteria>
- [ ] `src/jobforge/catalog/enrich.py` exists with `enrich_catalog()` function
- [ ] All COPS tables have `workforce_dynamic` field (demand or supply)
- [ ] Year columns have semantic descriptions (not "Column of type VARCHAR")
- [ ] dim_noc columns have meaningful descriptions
- [ ] Tests pass for enrichment logic
- [ ] Existing fields in catalog JSON are preserved
</success_criteria>

<output>
After completion, create `.planning/phases/12-schema-domain-intelligence/12-01-SUMMARY.md`
</output>
