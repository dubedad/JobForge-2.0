---
phase: 05-data-governance-lineage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/jobforge/governance/catalogue.py
  - data/catalog/tables/
  - tests/test_catalogue.py
autonomous: true

must_haves:
  truths:
    - "Data Catalogue includes all WiQ tables"
    - "Data Catalogue includes all columns with data types"
    - "Data Catalogue includes source system information"
    - "Data Catalogue includes row counts from physical parquet files"
    - "Catalogue is exportable as JSON for downstream consumption"
  artifacts:
    - path: "src/jobforge/governance/catalogue.py"
      provides: "CatalogueGenerator class"
      exports: ["CatalogueGenerator", "generate_catalogue"]
    - path: "data/catalog/tables/*.json"
      provides: "Per-table catalogue JSON files"
    - path: "tests/test_catalogue.py"
      provides: "Tests for catalogue generation"
      min_lines: 40
  key_links:
    - from: "src/jobforge/governance/catalogue.py"
      to: "data/catalog/schemas/wiq_schema.json"
      via: "json.loads()"
      pattern: "wiq_schema\\.json"
    - from: "src/jobforge/governance/catalogue.py"
      to: "data/gold/*.parquet"
      via: "pl.scan_parquet()"
      pattern: "scan_parquet"
---

<objective>
Generate Data Catalogue from WiQ schema and physical parquet files.

Purpose: Satisfy GOV-01 by producing comprehensive table and column documentation with source system, data types, and business descriptions. This catalogue becomes the authoritative metadata source for WiQ.

Output: CatalogueGenerator class that reads WiQ schema + parquet metadata and writes per-table JSON files to data/catalog/tables/.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-data-governance-lineage/05-RESEARCH.md

# Existing infrastructure
@src/jobforge/pipeline/models.py - TableMetadata and ColumnMetadata models
@src/jobforge/pipeline/catalog.py - CatalogManager.save_table_metadata()
@src/jobforge/pipeline/config.py - PipelineConfig paths
@data/catalog/schemas/wiq_schema.json - WiQ schema definition (first 100 lines shown in research)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CatalogueGenerator class</name>
  <files>src/jobforge/governance/catalogue.py</files>
  <action>
Create `src/jobforge/governance/catalogue.py` with CatalogueGenerator class:

```python
class CatalogueGenerator:
    """Generates Data Catalogue from WiQ schema and physical files."""

    def __init__(self, config: PipelineConfig):
        self.config = config
        self.catalog_manager = CatalogManager(config)

    def generate(self) -> list[TableMetadata]:
        """Generate catalogue for all WiQ tables.

        1. Load WiQ schema from data/catalog/schemas/wiq_schema.json
        2. For each table in schema:
           a. Get physical metadata from parquet file (row count, file size)
           b. Map schema columns to ColumnMetadata
           c. Create TableMetadata with business descriptions
           d. Save to data/catalog/tables/{table_name}.json
        3. Return list of generated TableMetadata
        """

    def _load_wiq_schema(self) -> dict:
        """Load WiQ schema JSON."""
        schema_path = self.config.catalog_schemas_path() / "wiq_schema.json"
        return json.loads(schema_path.read_text())

    def _generate_table_metadata(
        self,
        table_def: dict,
        parquet_path: Path | None
    ) -> TableMetadata:
        """Generate TableMetadata for a single table."""

    def _map_column_metadata(
        self,
        col_def: dict,
        sample_values: list[str] | None = None
    ) -> ColumnMetadata:
        """Map schema column to ColumnMetadata."""
```

Key implementation details:
- Use existing TableMetadata and ColumnMetadata from pipeline.models
- Source system: "JobForge WiQ Pipeline"
- Domain: Derive from table_type (fact -> "forecasting", dim -> "reference")
- Business descriptions: Map table_type to descriptions:
  - fact: "Forecasting and projection data"
  - dim: "Reference dimension data"
  - bridge: "Relationship mapping data"
- Column descriptions: Use is_primary_key/is_foreign_key to describe role
- Sample values: Read first 3 values from parquet using pl.scan_parquet().head(3)
- Handle missing parquet files gracefully (log warning, use defaults)
  </action>
  <verify>
    python -c "from jobforge.governance.catalogue import CatalogueGenerator; from jobforge.pipeline.config import PipelineConfig; print('CatalogueGenerator OK')"
  </verify>
  <done>
    - CatalogueGenerator class exists
    - generate() method reads WiQ schema and produces TableMetadata
    - Column metadata includes data types and FK/PK info
    - Source system correctly identified
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate catalogue JSON files for all WiQ tables</name>
  <files>
    data/catalog/tables/
    src/jobforge/governance/catalogue.py
  </files>
  <action>
1. Add generate_catalogue() convenience function to catalogue.py:
```python
def generate_catalogue(config: PipelineConfig | None = None) -> list[TableMetadata]:
    """Generate and save catalogue for all WiQ tables.

    Convenience function for CLI and scripts.
    """
    if config is None:
        config = PipelineConfig()
    generator = CatalogueGenerator(config)
    return generator.generate()
```

2. Run the generator to create catalogue files:
```python
from jobforge.governance.catalogue import generate_catalogue
from jobforge.pipeline.config import PipelineConfig

config = PipelineConfig()
tables = generate_catalogue(config)
print(f"Generated catalogue for {len(tables)} tables")
```

3. Verify JSON files created in data/catalog/tables/:
   - Each file named {table_name}.json
   - Contains full TableMetadata JSON
   - Row counts match parquet files
  </action>
  <verify>
    python -c "from jobforge.governance.catalogue import generate_catalogue; tables = generate_catalogue(); print(f'Generated {len(tables)} table catalogues')"
  </verify>
  <done>
    - All WiQ tables have catalogue JSON files in data/catalog/tables/
    - JSON files contain correct metadata (verified by loading a few)
    - Row counts match actual parquet file row counts
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for CatalogueGenerator</name>
  <files>tests/test_catalogue.py</files>
  <action>
Create `tests/test_catalogue.py` with tests:

1. Test schema loading:
   - test_load_wiq_schema: Verify schema loads correctly
   - test_schema_has_tables: Verify tables array exists

2. Test metadata generation:
   - test_generate_creates_metadata_for_all_tables: Verify count matches schema
   - test_table_metadata_has_required_fields: Check table_name, layer, columns
   - test_column_metadata_has_data_types: Verify data_type populated
   - test_column_metadata_tracks_fk_relations: Verify is_foreign_key, references_table

3. Test file output:
   - test_generate_saves_json_files: Verify files created in data/catalog/tables/
   - test_json_files_are_valid: Load and validate a few JSON files

4. Test edge cases:
   - test_missing_parquet_uses_defaults: If parquet missing, row_count = 0

Use real data (WiQ schema, parquet files).
  </action>
  <verify>
    pytest tests/test_catalogue.py -v
  </verify>
  <done>
    - All tests pass
    - Tests cover schema loading, metadata generation, file output
    - Tests validate real catalogue output
  </done>
</task>

</tasks>

<verification>
1. Module exists: `python -c "from jobforge.governance.catalogue import CatalogueGenerator, generate_catalogue"`
2. Catalogue files created: `ls data/catalog/tables/*.json | wc -l` matches WiQ table count
3. Metadata complete: Load any JSON file, verify table_name, columns, row_count present
4. Source system correct: grep "JobForge WiQ Pipeline" in any catalogue JSON
5. Tests pass: `pytest tests/test_catalogue.py -v` all green
</verification>

<success_criteria>
- CatalogueGenerator class exists in src/jobforge/governance/catalogue.py
- All WiQ tables have catalogue JSON files in data/catalog/tables/
- Each catalogue includes: table_name, columns (with data_type), source_system, row_count
- Foreign key relationships documented in column metadata
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-governance-lineage/05-02-SUMMARY.md`
</output>
