---
phase: 09-demo-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/settings.local.json
  - .claude/commands/stage-gold.md
  - pyproject.toml
  - src/jobforge/demo/__init__.py
  - src/jobforge/demo/events.py
  - src/jobforge/demo/orchestrator.py
  - src/jobforge/demo/app.py
  - src/jobforge/cli/commands.py
  - tests/demo/test_events.py
  - tests/demo/test_orchestrator.py
autonomous: true

must_haves:
  truths:
    - "MCP permissions from prototype are ported and working"
    - "/stagegold command ported from prototype for Claude Code to execute"
    - "SSE endpoint streams deployment NARRATION events in real-time"
    - "Demo CLI command starts web server"
    - "DemoOrchestrator yields metadata events describing deployment progress"
  artifacts:
    - path: ".claude/settings.local.json"
      provides: "MCP permissions for Power BI operations"
      contains: "mcp__powerbi-modeling__"
    - path: ".claude/commands/stage-gold.md"
      provides: "Claude Code command for Power BI deployment"
      contains: "connection_operations"
    - path: "src/jobforge/demo/events.py"
      provides: "SSE event models"
      exports: ["DemoEvent", "EventType"]
    - path: "src/jobforge/demo/orchestrator.py"
      provides: "SSE-streaming narration generator"
      exports: ["DemoOrchestrator"]
    - path: "src/jobforge/demo/app.py"
      provides: "Starlette app with SSE endpoint"
      exports: ["create_app"]
  key_links:
    - from: "src/jobforge/demo/orchestrator.py"
      to: "src/jobforge/deployment/deployer.py"
      via: "WiQDeployer usage for schema reading"
      pattern: "WiQDeployer"
    - from: "src/jobforge/demo/app.py"
      to: "src/jobforge/demo/orchestrator.py"
      via: "orchestrator.stream_deployment"
      pattern: "DemoOrchestrator"
    - from: "src/jobforge/cli/commands.py"
      to: "src/jobforge/demo/app.py"
      via: "uvicorn.run(create_app)"
      pattern: "create_app"
---

<objective>
Port MCP configuration from prototype and create SSE backend for live demo NARRATION streaming.

Purpose: Enable real-time narration via web interface showing what IS BEING deployed (by Claude Code externally), fulfilling MCP-01 (MCP configuration) and partial MCP-02 (SSE backend for live demo).

**Important architecture note:** The DemoOrchestrator provides NARRATION (metadata about what will be/is being deployed) - it does NOT execute the actual MCP deployment. The actual deployment is triggered by the user running `/stagegold` via Claude Code in a separate VS Code Pro session. The web UI provides visual feedback synchronized with that external deployment.

**Prerequisites for demo (from prototype stage-gold.md):**
- Power BI Desktop must be open with a blank or target .pbix file
- The file should be saved before running `/stagegold`
- Claude Code connects via MCP using `connection_operations` with `ListLocalInstances`

Output: Working SSE backend that streams narration events, CLI command to start demo server, and MCP permissions for Power BI operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-demo-infrastructure/09-CONTEXT.md
@.planning/phases/09-demo-infrastructure/09-RESEARCH.md

# Existing deployment infrastructure
@src/jobforge/deployment/deployer.py
@src/jobforge/deployment/mcp_client.py
@src/jobforge/deployment/ui.py
@src/jobforge/cli/commands.py

# Prototype MCP config (reference for porting)
# Source: c:\Users\Administrator\Dropbox\++ Results Kit\JobForge\.claude\settings.local.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port MCP Configuration, Stage-Gold Command, and Add Dependencies</name>
  <files>
    - .claude/settings.local.json
    - .claude/commands/stage-gold.md
    - pyproject.toml
  </files>
  <action>
1. Update `.claude/settings.local.json` to add all Power BI MCP Server permissions from prototype:
   - mcp__powerbi-modeling__table_operations
   - mcp__powerbi-modeling__relationship_operations
   - mcp__powerbi-modeling__named_expression_operations
   - mcp__powerbi-modeling__column_operations
   - mcp__powerbi-modeling__partition_operations
   - mcp__powerbi-modeling__model_operations
   - mcp__powerbi-modeling__dax_query_operations
   - mcp__powerbi-modeling__batch_table_operations
   - mcp__powerbi-modeling__measure_operations
   - mcp__powerbi-modeling__batch_column_operations
   - mcp__powerbi-modeling__connection_operations
   - mcp__powerbi-modeling__batch_measure_operations
   - mcp__powerbi-modeling__database_operations
   - mcp__powerbi-modeling__transaction_operations

2. Add demo infrastructure dependencies to `pyproject.toml`:
   ```toml
   "uvicorn>=0.30.0",
   "starlette>=0.38.0",
   "sse-starlette>=2.0.0",
   ```

3. Keep existing permissions in settings.local.json; append the MCP permissions.

4. Create `.claude/commands/stage-gold.md`:
   - Port from prototype at `c:\Users\Administrator\Dropbox\++ Results Kit\JobForge\.claude\commands\stage-gold.md`
   - Update parquet file paths from `JobForge\backend\data\` to `JobForge 2.0\data\gold\` (or appropriate gold layer paths)
   - Preserve the MCP connection flow:
     - Step 1: Connect to Power BI Desktop using `connection_operations` with `ListLocalInstances`
     - Step 2: Create tables (dim_noc first, then facts)
     - Step 3: Create relationships
     - Step 4: Create measures
     - Step 5: Validation
   - Update table schemas if WiQ model differs from prototype
   - Keep the prerequisite documentation:
     ```markdown
     ## Prerequisites
     - Power BI Desktop must be open with a blank or target .pbix file
     - The file should be saved before running this command
     ```

Note: The MCP permissions enable Claude Code (running in VS Code Pro) to interact with Power BI Desktop via the Power BI MCP Server during live demos. These permissions are used by the EXTERNAL Claude Code session, not by the Python backend. The `/stagegold` command is executed by the USER in Claude Code to trigger the actual deployment.
  </action>
  <verify>
    - Run `pip install -e .` to verify dependencies install
    - Verify `.claude/settings.local.json` contains all mcp__powerbi-modeling__ permissions
    - Verify `.claude/commands/stage-gold.md` exists and has correct paths for JobForge 2.0
    - Verify stage-gold.md includes prerequisites and MCP connection flow
  </verify>
  <done>MCP permissions ported, stage-gold command created, dependencies installable</done>
</task>

<task type="auto">
  <name>Task 2: Create SSE Event Models and Demo Orchestrator (Narration Layer)</name>
  <files>
    - src/jobforge/demo/__init__.py
    - src/jobforge/demo/events.py
    - src/jobforge/demo/orchestrator.py
    - tests/demo/__init__.py
    - tests/demo/test_events.py
    - tests/demo/test_orchestrator.py
  </files>
  <action>
**Architecture clarification:** The DemoOrchestrator provides NARRATION - it reads the WiQ schema and yields metadata events describing what WILL BE deployed. It does NOT invoke MCP tools or execute deployment. The actual deployment is triggered externally by the user running `/stagegold` in Claude Code (VS Code Pro).

Demo flow:
1. User opens Power BI Desktop with a blank or target .pbix file and SAVES it
2. User opens JobForge web UI in browser (served by `jobforge demo`)
3. User clicks "Load" -> SSE stream starts, showing what will be built
4. User ALSO has Claude Code open in VS Code Pro, runs `/stagegold`
5. Claude Code connects to Power BI Desktop via MCP (`connection_operations` -> `ListLocalInstances` -> Connect)
6. Claude Code (with MCP permissions) executes the actual deployment to Power BI
7. The web UI narration and Claude Code execution happen in parallel
8. User manually arranges windows (browser + Power BI Desktop side-by-side)

1. Create `src/jobforge/demo/__init__.py` with exports:
   ```python
   from jobforge.demo.events import DemoEvent, EventType
   from jobforge.demo.orchestrator import DemoOrchestrator
   __all__ = ["DemoEvent", "EventType", "DemoOrchestrator"]
   ```

2. Create `src/jobforge/demo/events.py`:
   - Define `EventType` enum: START, TABLE, RELATIONSHIP, MEASURE, COMPLETE, ERROR, HEARTBEAT
   - Define `DemoEvent` dataclass with:
     - event_type: EventType
     - data: dict (JSON-serializable payload)
     - timestamp: datetime (default to now)
   - Add `to_sse_dict()` method returning {"event": str, "data": json.dumps(data)}
   - Events carry deployment METADATA: table name, source, column count, relationship cardinality, etc.
   - These describe what IS BEING deployed, not trigger the deployment

3. Create `src/jobforge/demo/orchestrator.py`:
   - Import `WiQDeployer`, `DeploymentUI`, `get_table_source` from deployment module
   - Create `DemoOrchestrator` class:
     - __init__(self, schema_path: Path | None = None)
     - async def stream_deployment(self) -> AsyncGenerator[DemoEvent, None]:
       - **NARRATION ONLY** - reads schema and yields events describing what will be deployed
       - Uses WiQDeployer.load_schema() and get_deployment_order() to READ metadata
       - Does NOT call MCP tools or execute any deployment
       - Yields START event with total_tables, total_relationships count
       - For each table: yield TABLE event with name, table_type, source, column_count
       - For each relationship: yield RELATIONSHIP event with from_table, to_table, cardinality
       - Yields COMPLETE event with success=True, duration_ms
       - On exception: yields ERROR event with message
       - Include small delays (asyncio.sleep(0.05)) between events for visual effect
     - get_catalogue_data() method returning TableMetadata list for catalogue step

4. Create test files:
   - `tests/demo/__init__.py` (empty)
   - `tests/demo/test_events.py`:
     - Test EventType enum has all expected values
     - Test DemoEvent.to_sse_dict() returns correct format
   - `tests/demo/test_orchestrator.py`:
     - Test DemoOrchestrator instantiation
     - Test stream_deployment yields events in correct order (START, TABLE..., RELATIONSHIP..., COMPLETE)
     - Mock WiQDeployer to avoid file dependencies
     - Verify no MCP calls are made (this is narration only)
  </action>
  <verify>
    - Run `pytest tests/demo/ -v`
    - All tests pass
    - Verify orchestrator.py does NOT import or call MCPClient
  </verify>
  <done>SSE event models and narration-only orchestrator with tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Create Starlette App and CLI Command</name>
  <files>
    - src/jobforge/demo/app.py
    - src/jobforge/cli/commands.py
  </files>
  <action>
1. Create `src/jobforge/demo/app.py`:
   - Import from starlette: Starlette, Route, Mount
   - Import StaticFiles from starlette.staticfiles
   - Import EventSourceResponse from sse_starlette.sse
   - Import DemoOrchestrator from jobforge.demo.orchestrator

   - Create `deployment_stream(request)` async function:
     - Get schema_path from query params (optional)
     - Create DemoOrchestrator(schema_path)
     - Define async generator that yields from orchestrator.stream_deployment()
     - Return EventSourceResponse with headers:
       - Cache-Control: no-cache
       - X-Accel-Buffering: no (disable nginx buffering)
     - Note: This streams NARRATION events describing deployment metadata

   - Create `catalogue_data(request)` async function:
     - Return JSON response with catalogue metadata

   - Define `create_app(static_dir: Path | None = None) -> Starlette`:
     - Routes:
       - Route("/api/deploy/stream", deployment_stream)
       - Route("/api/catalogue", catalogue_data)
       - Mount("/", StaticFiles(directory=static_dir, html=True)) if static_dir exists
     - Return Starlette app

2. Update `src/jobforge/cli/commands.py`:
   - Add `demo` command using Typer:
     ```python
     @app.command()
     def demo(
         port: int = typer.Option(8080, "--port", "-p", help="Server port"),
         host: str = typer.Option("127.0.0.1", "--host", "-h", help="Server host"),
         schema_path: Optional[Path] = typer.Option(None, "--schema", "-s"),
     ) -> None:
         """Start demo web server for live deployment narration.

         The web server streams deployment NARRATION showing what is being built.
         Actual deployment is triggered separately via /stagegold in Claude Code (VS Code Pro).

         PREREQUISITES:
         - Power BI Desktop must be open with a saved .pbix file (blank or target)
         - The .pbix file must be saved BEFORE running /stagegold

         Recommended demo setup:
         1. Open Power BI Desktop and save a blank .pbix file
         2. Start this server: jobforge demo
         3. Open browser to http://localhost:8080
         4. Arrange windows side-by-side: browser + Power BI Desktop
         5. In VS Code Pro, run /stagegold to trigger actual deployment
         """
         import uvicorn
         from jobforge.demo.app import create_app

         # Static files location (will be created in Plan 02)
         static_dir = Path(__file__).parent.parent / "demo" / "static"

         app = create_app(static_dir if static_dir.exists() else None)

         typer.echo(f"Starting JobForge demo server at http://{host}:{port}")
         typer.echo("Press Ctrl+C to stop")

         uvicorn.run(app, host=host, port=port)
     ```

3. Update `src/jobforge/demo/__init__.py` to export `create_app`
  </action>
  <verify>
    - Run `jobforge demo --help` shows command options
    - Run `jobforge demo` starts server on port 8080
    - Run `curl http://localhost:8080/api/deploy/stream` returns SSE events (will show events then close)
    - Run pytest to ensure no regressions
  </verify>
  <done>Demo server startable via CLI, SSE endpoint functional</done>
</task>

</tasks>

<verification>
1. MCP permissions in `.claude/settings.local.json` include all powerbi-modeling operations
2. `.claude/commands/stage-gold.md` exists with:
   - Correct parquet paths for JobForge 2.0
   - Prerequisites section (Power BI Desktop open with saved .pbix)
   - MCP connection flow (ListLocalInstances -> Connect)
3. `pip install -e .` installs without errors including new dependencies
4. `pytest tests/demo/ -v` passes all tests
5. `pytest` (full suite) passes with no regressions
6. `jobforge demo` starts web server
7. `curl http://localhost:8080/api/deploy/stream` returns SSE event stream (narration events)
8. Verify DemoOrchestrator does NOT import MCPClient (narration only, no deployment execution)
</verification>

<success_criteria>
- MCP-01 satisfied: MCP configuration ported from prototype (for Claude Code to use)
- `/stagegold` command ported from prototype (with updated paths for JobForge 2.0)
- SSE backend ready for UI integration (partial MCP-02)
- DemoOrchestrator provides narration (metadata streaming), NOT deployment execution
- CLI command `jobforge demo` starts server with clear help text explaining architecture
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/09-demo-infrastructure/09-01-SUMMARY.md`
</output>
