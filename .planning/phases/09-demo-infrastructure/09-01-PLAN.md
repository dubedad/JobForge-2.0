---
phase: 09-demo-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/settings.local.json
  - pyproject.toml
  - src/jobforge/demo/__init__.py
  - src/jobforge/demo/events.py
  - src/jobforge/demo/orchestrator.py
  - src/jobforge/demo/app.py
  - src/jobforge/cli/commands.py
  - tests/demo/test_events.py
  - tests/demo/test_orchestrator.py
autonomous: true

must_haves:
  truths:
    - "MCP permissions from prototype are ported and working"
    - "SSE endpoint streams deployment events in real-time"
    - "Demo CLI command starts web server"
    - "WiQDeployer integration emits events during deployment"
  artifacts:
    - path: ".claude/settings.local.json"
      provides: "MCP permissions for Power BI operations"
      contains: "mcp__powerbi-modeling__"
    - path: "src/jobforge/demo/events.py"
      provides: "SSE event models"
      exports: ["DemoEvent", "EventType"]
    - path: "src/jobforge/demo/orchestrator.py"
      provides: "SSE-streaming WiQDeployer wrapper"
      exports: ["DemoOrchestrator"]
    - path: "src/jobforge/demo/app.py"
      provides: "Starlette app with SSE endpoint"
      exports: ["create_app"]
  key_links:
    - from: "src/jobforge/demo/orchestrator.py"
      to: "src/jobforge/deployment/deployer.py"
      via: "WiQDeployer usage"
      pattern: "WiQDeployer"
    - from: "src/jobforge/demo/app.py"
      to: "src/jobforge/demo/orchestrator.py"
      via: "orchestrator.stream_deployment"
      pattern: "DemoOrchestrator"
    - from: "src/jobforge/cli/commands.py"
      to: "src/jobforge/demo/app.py"
      via: "uvicorn.run(create_app)"
      pattern: "create_app"
---

<objective>
Port MCP configuration from prototype and create SSE backend for live demo streaming.

Purpose: Enable real-time deployment streaming via web interface, fulfilling MCP-01 (MCP configuration) and partial MCP-02 (SSE backend for live demo).

Output: Working SSE backend that streams deployment events, CLI command to start demo server, and MCP permissions for Power BI operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-demo-infrastructure/09-CONTEXT.md
@.planning/phases/09-demo-infrastructure/09-RESEARCH.md

# Existing deployment infrastructure
@src/jobforge/deployment/deployer.py
@src/jobforge/deployment/mcp_client.py
@src/jobforge/deployment/ui.py
@src/jobforge/cli/commands.py

# Prototype MCP config (reference for porting)
# Source: c:\Users\Administrator\Dropbox\++ Results Kit\JobForge\.claude\settings.local.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port MCP Configuration and Add Dependencies</name>
  <files>
    - .claude/settings.local.json
    - pyproject.toml
  </files>
  <action>
1. Update `.claude/settings.local.json` to add all Power BI MCP Server permissions from prototype:
   - mcp__powerbi-modeling__table_operations
   - mcp__powerbi-modeling__relationship_operations
   - mcp__powerbi-modeling__named_expression_operations
   - mcp__powerbi-modeling__column_operations
   - mcp__powerbi-modeling__partition_operations
   - mcp__powerbi-modeling__model_operations
   - mcp__powerbi-modeling__dax_query_operations
   - mcp__powerbi-modeling__batch_table_operations
   - mcp__powerbi-modeling__measure_operations
   - mcp__powerbi-modeling__batch_column_operations
   - mcp__powerbi-modeling__connection_operations
   - mcp__powerbi-modeling__batch_measure_operations
   - mcp__powerbi-modeling__database_operations
   - mcp__powerbi-modeling__transaction_operations

2. Add demo infrastructure dependencies to `pyproject.toml`:
   ```toml
   "uvicorn>=0.30.0",
   "starlette>=0.38.0",
   "sse-starlette>=2.0.0",
   ```

3. Keep existing permissions in settings.local.json; append the MCP permissions.

Note: The MCP permissions enable Claude to interact with Power BI Desktop via the Power BI MCP Server during live demos.
  </action>
  <verify>
    - Run `pip install -e .` to verify dependencies install
    - Verify `.claude/settings.local.json` contains all mcp__powerbi-modeling__ permissions
  </verify>
  <done>MCP permissions ported, dependencies installable</done>
</task>

<task type="auto">
  <name>Task 2: Create SSE Event Models and Demo Orchestrator</name>
  <files>
    - src/jobforge/demo/__init__.py
    - src/jobforge/demo/events.py
    - src/jobforge/demo/orchestrator.py
    - tests/demo/__init__.py
    - tests/demo/test_events.py
    - tests/demo/test_orchestrator.py
  </files>
  <action>
1. Create `src/jobforge/demo/__init__.py` with exports:
   ```python
   from jobforge.demo.events import DemoEvent, EventType
   from jobforge.demo.orchestrator import DemoOrchestrator
   __all__ = ["DemoEvent", "EventType", "DemoOrchestrator"]
   ```

2. Create `src/jobforge/demo/events.py`:
   - Define `EventType` enum: START, TABLE, RELATIONSHIP, MEASURE, COMPLETE, ERROR, HEARTBEAT
   - Define `DemoEvent` dataclass with:
     - event_type: EventType
     - data: dict (JSON-serializable payload)
     - timestamp: datetime (default to now)
   - Add `to_sse_dict()` method returning {"event": str, "data": json.dumps(data)}
   - Events carry deployment progress: table name, source, column count, relationship cardinality, etc.

3. Create `src/jobforge/demo/orchestrator.py`:
   - Import `WiQDeployer`, `DeploymentUI`, `get_table_source` from deployment module
   - Create `DemoOrchestrator` class:
     - __init__(self, schema_path: Path | None = None)
     - async def stream_deployment(self) -> AsyncGenerator[DemoEvent, None]:
       - Yields START event with total_tables, total_relationships count
       - For each table: yield TABLE event with name, table_type, source, column_count
       - For each relationship: yield RELATIONSHIP event with from_table, to_table, cardinality
       - Yields COMPLETE event with success=True, duration_ms
       - On exception: yields ERROR event with message
       - Include small delays (asyncio.sleep(0.05)) between events for visual effect
     - get_catalogue_data() method returning TableMetadata list for catalogue step
   - Use existing `WiQDeployer.load_schema()` and `WiQDeployer.get_deployment_order()`

4. Create test files:
   - `tests/demo/__init__.py` (empty)
   - `tests/demo/test_events.py`:
     - Test EventType enum has all expected values
     - Test DemoEvent.to_sse_dict() returns correct format
   - `tests/demo/test_orchestrator.py`:
     - Test DemoOrchestrator instantiation
     - Test stream_deployment yields events in correct order (START, TABLE..., RELATIONSHIP..., COMPLETE)
     - Mock WiQDeployer to avoid file dependencies
  </action>
  <verify>
    - Run `pytest tests/demo/ -v`
    - All tests pass
  </verify>
  <done>SSE event models and orchestrator with tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Create Starlette App and CLI Command</name>
  <files>
    - src/jobforge/demo/app.py
    - src/jobforge/cli/commands.py
  </files>
  <action>
1. Create `src/jobforge/demo/app.py`:
   - Import from starlette: Starlette, Route, Mount
   - Import StaticFiles from starlette.staticfiles
   - Import EventSourceResponse from sse_starlette.sse
   - Import DemoOrchestrator from jobforge.demo.orchestrator

   - Create `deployment_stream(request)` async function:
     - Get schema_path from query params (optional)
     - Create DemoOrchestrator(schema_path)
     - Define async generator that yields from orchestrator.stream_deployment()
     - Return EventSourceResponse with headers:
       - Cache-Control: no-cache
       - X-Accel-Buffering: no (disable nginx buffering)

   - Create `catalogue_data(request)` async function:
     - Return JSON response with catalogue metadata

   - Define `create_app(static_dir: Path | None = None) -> Starlette`:
     - Routes:
       - Route("/api/deploy/stream", deployment_stream)
       - Route("/api/catalogue", catalogue_data)
       - Mount("/", StaticFiles(directory=static_dir, html=True)) if static_dir exists
     - Return Starlette app

2. Update `src/jobforge/cli/commands.py`:
   - Add `demo` command using Typer:
     ```python
     @app.command()
     def demo(
         port: int = typer.Option(8080, "--port", "-p", help="Server port"),
         host: str = typer.Option("127.0.0.1", "--host", "-h", help="Server host"),
         schema_path: Optional[Path] = typer.Option(None, "--schema", "-s"),
     ) -> None:
         """Start demo web server for live deployment demonstrations."""
         import uvicorn
         from jobforge.demo.app import create_app

         # Static files location (will be created in Plan 02)
         static_dir = Path(__file__).parent.parent / "demo" / "static"

         app = create_app(static_dir if static_dir.exists() else None)

         typer.echo(f"Starting JobForge demo server at http://{host}:{port}")
         typer.echo("Press Ctrl+C to stop")

         uvicorn.run(app, host=host, port=port)
     ```

3. Update `src/jobforge/demo/__init__.py` to export `create_app`
  </action>
  <verify>
    - Run `jobforge demo --help` shows command options
    - Run `jobforge demo` starts server on port 8080
    - Run `curl http://localhost:8080/api/deploy/stream` returns SSE events (will show events then close)
    - Run pytest to ensure no regressions
  </verify>
  <done>Demo server startable via CLI, SSE endpoint functional</done>
</task>

</tasks>

<verification>
1. MCP permissions in `.claude/settings.local.json` include all powerbi-modeling operations
2. `pip install -e .` installs without errors including new dependencies
3. `pytest tests/demo/ -v` passes all tests
4. `pytest` (full suite) passes with no regressions
5. `jobforge demo` starts web server
6. `curl http://localhost:8080/api/deploy/stream` returns SSE event stream
</verification>

<success_criteria>
- MCP-01 satisfied: MCP configuration ported from prototype
- SSE backend ready for UI integration (partial MCP-02)
- CLI command `jobforge demo` starts server
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/09-demo-infrastructure/09-01-SUMMARY.md`
</output>
