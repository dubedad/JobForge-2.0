---
phase: 11-validation-and-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/jobforge/api/routes.py
  - src/jobforge/api/errors.py
  - tests/api/test_error_responses.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User receives actionable error message when query fails (not raw stack trace)"
    - "Error responses follow RFC 9457 Problem Details format"
    - "Cross-origin requests from Orbit frontend to JobForge API succeed"
  artifacts:
    - path: "src/jobforge/api/errors.py"
      provides: "RFC 9457 ProblemDetail model and exception handlers"
      exports: ["ProblemDetail", "create_problem_detail", "register_error_handlers"]
    - path: "src/jobforge/api/routes.py"
      provides: "FastAPI app with CORS and error handlers"
      contains: "CORSMiddleware"
    - path: "tests/api/test_error_responses.py"
      provides: "Error response format validation"
      min_lines: 50
  key_links:
    - from: "src/jobforge/api/routes.py"
      to: "src/jobforge/api/errors.py"
      via: "register_error_handlers(app)"
      pattern: "register_error_handlers"
    - from: "src/jobforge/api/routes.py"
      to: "CORSMiddleware"
      via: "app.add_middleware"
      pattern: "CORSMiddleware"
---

<objective>
Harden JobForge API error handling with RFC 9457 Problem Details and add CORS middleware for Orbit cross-origin access.

Purpose: ORB-04 requires user-friendly error messages with actionable guidance (not raw stack traces). CORS is prerequisite for browser-based Orbit frontend to call JobForge API.

Output: RFC 9457-compliant error responses, CORS-enabled API, test coverage for error formats.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing API implementation
@src/jobforge/api/routes.py
@src/jobforge/api/data_query.py

# Existing test patterns
@tests/api/test_routes.py

# Research recommendations
@.planning/phases/11-validation-and-hardening/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RFC 9457 error handling module</name>
  <files>src/jobforge/api/errors.py</files>
  <action>
Create new module `src/jobforge/api/errors.py` with:

1. `ProblemDetail` Pydantic model following RFC 9457:
   - `type`: str (URI reference, e.g., "/errors/validation-failed")
   - `title`: str (human-readable summary)
   - `status`: int (HTTP status code)
   - `detail`: str (specific explanation with actionable guidance)
   - `instance`: str | None (URI to this occurrence)

2. `create_problem_detail()` helper function that builds ProblemDetail dicts.

3. Exception handlers for FastAPI:
   - `validation_error_handler`: Handle ValueError, return 400 with "Check your query syntax" guidance
   - `query_error_handler`: Handle DataQueryError (new custom exception), return 400 with query-specific guidance
   - `not_found_handler`: Handle table/resource not found, return 404 with "Available tables: ..." guidance
   - `generic_error_handler`: Handle Exception, log full error, return sanitized 500 with "Try again or contact support"

4. `register_error_handlers(app: FastAPI)` function that registers all handlers.

Error messages must be actionable:
- Bad: "Catalog entry not found at /internal/path"
- Good: "Table 'foo' not found. Available tables: dim_noc, dim_occupations, ..."

Log full error details with structlog, return sanitized message to user.
Set Content-Type header to "application/problem+json".
  </action>
  <verify>
Run: `python -c "from jobforge.api.errors import ProblemDetail, register_error_handlers; print('OK')"`
Verify imports work and module structure is correct.
  </verify>
  <done>ProblemDetail model exists with all RFC 9457 fields, exception handlers registered via register_error_handlers()</done>
</task>

<task type="auto">
  <name>Task 2: Add CORS middleware and integrate error handlers</name>
  <files>src/jobforge/api/routes.py</files>
  <action>
Modify `src/jobforge/api/routes.py`:

1. Import from new errors module:
   ```python
   from jobforge.api.errors import register_error_handlers
   ```

2. Add CORS middleware as FIRST middleware (order matters):
   ```python
   from fastapi.middleware.cors import CORSMiddleware
   import os

   # Get allowed origins from environment (comma-separated)
   origins_str = os.getenv("CORS_ORIGINS", "http://localhost:3000,http://localhost:8080")
   allowed_origins = [o.strip() for o in origins_str.split(",")]

   api_app.add_middleware(
       CORSMiddleware,
       allow_origins=allowed_origins,
       allow_credentials=True,
       allow_methods=["GET", "POST"],
       allow_headers=["Content-Type", "Authorization"],
       max_age=3600,
   )
   ```

3. Register error handlers AFTER creating app:
   ```python
   register_error_handlers(api_app)
   ```

4. Update existing exception handling in endpoints to use new error format:
   - In `query_data`: Instead of `raise HTTPException(status_code=400, detail=result.error)`,
     raise a custom `QueryError` that the handler will catch and format properly.
   - In `get_compliance`: Same pattern for unknown framework errors.

5. Keep existing health and tables endpoints unchanged (they work fine).

CRITICAL: Add CORS middleware BEFORE any other middleware. The order in FastAPI matters for middleware execution.
  </action>
  <verify>
Run: `python -c "from jobforge.api.routes import app; print('CORS:', any('CORSMiddleware' in str(m) for m in app.user_middleware))"`
Verify CORS middleware is registered.
  </verify>
  <done>CORS middleware configured with environment-based origins, error handlers integrated, endpoints use RFC 9457 format</done>
</task>

<task type="auto">
  <name>Task 3: Add error response format tests</name>
  <files>tests/api/test_error_responses.py</files>
  <action>
Create new test file `tests/api/test_error_responses.py`:

1. Test RFC 9457 format compliance:
   ```python
   def test_error_response_has_problem_detail_fields(client):
       """Test error responses include RFC 9457 required fields."""
       # Trigger an error (e.g., query nonexistent framework)
       response = client.get("/api/compliance/nonexistent")
       assert response.status_code in [400, 404]
       data = response.json()
       assert "type" in data
       assert "title" in data
       assert "status" in data
       assert "detail" in data
       assert response.headers.get("content-type") == "application/problem+json"
   ```

2. Test actionable error messages:
   ```python
   def test_error_message_is_actionable(client):
       """Test error messages provide guidance, not stack traces."""
       response = client.get("/api/compliance/unknown")
       data = response.json()
       # Should NOT contain internal paths or Python tracebacks
       assert "/internal/" not in data.get("detail", "")
       assert "Traceback" not in data.get("detail", "")
       # Should contain guidance
       assert any(word in data.get("detail", "").lower() for word in ["available", "try", "check", "valid"])
   ```

3. Test data query error handling (with mocked Claude):
   ```python
   def test_data_query_error_returns_problem_detail(client_with_mock_error):
       """Test data query errors return RFC 9457 format."""
       response = client_with_mock_error.post(
           "/api/query/data",
           json={"question": "bad query"}
       )
       assert response.status_code == 400
       data = response.json()
       assert data.get("type", "").startswith("/errors/")
   ```

4. Test CORS headers present:
   ```python
   def test_cors_headers_present(client):
       """Test CORS headers are returned."""
       response = client.options(
           "/api/query/data",
           headers={"Origin": "http://localhost:3000"}
       )
       assert "access-control-allow-origin" in response.headers
   ```

Follow existing test patterns from tests/api/test_routes.py for fixtures.
  </action>
  <verify>
Run: `pytest tests/api/test_error_responses.py -v`
All tests should pass.
  </verify>
  <done>Error response tests pass, validating RFC 9457 compliance and actionable messages</done>
</task>

</tasks>

<verification>
Run full API test suite:
```bash
pytest tests/api/ -v
```

Manual verification:
```bash
# Start API
jobforge api &

# Test CORS preflight
curl -X OPTIONS http://localhost:8000/api/query/data -H "Origin: http://localhost:3000" -i

# Test error format
curl http://localhost:8000/api/compliance/unknown -i
# Should return application/problem+json with RFC 9457 fields
```
</verification>

<success_criteria>
- [ ] `src/jobforge/api/errors.py` exists with ProblemDetail model
- [ ] CORS middleware configured in routes.py
- [ ] Error responses include type, title, status, detail fields
- [ ] Error responses use Content-Type: application/problem+json
- [ ] Error messages are actionable (no stack traces, include guidance)
- [ ] All tests in tests/api/ pass
- [ ] CORS preflight requests return appropriate headers
</success_criteria>

<output>
After completion, create `.planning/phases/11-validation-and-hardening/11-01-SUMMARY.md`
</output>
