---
phase: 07-external-data-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/jobforge/external/__init__.py
  - src/jobforge/external/models.py
  - src/jobforge/external/onet/__init__.py
  - src/jobforge/external/onet/crosswalk.py
  - src/jobforge/external/onet/client.py
  - src/jobforge/external/onet/adapter.py
  - tests/test_onet.py
  - data/crosswalk/noc2021_onet26.csv
autonomous: true
user_setup:
  - service: onet
    why: "O*NET API requires registered credentials"
    env_vars:
      - name: ONET_API_KEY
        source: "https://services.onetcenter.org/developer/ -> Sign up -> Get API key"

must_haves:
  truths:
    - "User can query O*NET attributes given a NOC code"
    - "NOC-SOC crosswalk maps NOC 2021 codes to O*NET 26 SOC codes"
    - "1:N cardinality handled - one NOC may map to multiple SOC codes"
    - "O*NET attributes carry provenance with source_type='ONET'"
  artifacts:
    - path: "src/jobforge/external/onet/crosswalk.py"
      provides: "NOC-SOC crosswalk loading and lookup"
      exports: ["NOCSOCCrosswalk"]
    - path: "src/jobforge/external/onet/client.py"
      provides: "O*NET Web Services API client"
      exports: ["ONetClient"]
    - path: "src/jobforge/external/onet/adapter.py"
      provides: "O*NET to WiQ schema conversion"
      exports: ["ONetAdapter", "get_attributes_for_noc"]
    - path: "data/crosswalk/noc2021_onet26.csv"
      provides: "Brookfield NOC-O*NET crosswalk data"
      contains: "noc,onet columns"
  key_links:
    - from: "src/jobforge/external/onet/adapter.py"
      to: "src/jobforge/external/onet/crosswalk.py"
      via: "NOCSOCCrosswalk instance"
      pattern: "crosswalk\\.noc_to_soc"
    - from: "src/jobforge/external/onet/adapter.py"
      to: "src/jobforge/external/onet/client.py"
      via: "ONetClient for API calls"
      pattern: "client\\.get_.*"
---

<objective>
Integrate O*NET Web Services API for fetching SOC-aligned attributes given a NOC code.

Purpose: Enable WiQ to pull skills, abilities, and knowledge from O*NET when hierarchical inheritance leaves gaps. O*NET data supplements Canadian authoritative sources with US occupational data.

Output: Working `jobforge.external.onet` package with crosswalk loading, API client, and adapter that converts O*NET schema to WiQ imputation schema.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-external-data-integration/07-RESEARCH.md
@.planning/phases/07-external-data-integration/07-CONTEXT.md
@src/jobforge/imputation/models.py
@src/jobforge/imputation/provenance.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create external package with O*NET crosswalk loader</name>
  <files>
    - src/jobforge/external/__init__.py
    - src/jobforge/external/models.py
    - src/jobforge/external/onet/__init__.py
    - src/jobforge/external/onet/crosswalk.py
    - data/crosswalk/noc2021_onet26.csv
  </files>
  <action>
Create the external data integration package structure:

1. **Download Brookfield crosswalk** (MIT license):
   - Source: https://github.com/BrookfieldIIE/NOC_ONet_Crosswalk
   - File: noc2021_onet26.csv (1,468 mappings)
   - Place in: data/crosswalk/noc2021_onet26.csv

2. **Create external/models.py** with Pydantic models:
   - `ONetAttribute`: Single attribute from O*NET (element_id, name, description, importance_score 0-100, level_score, source_soc, source_noc)
   - `ONetAttributeSet`: Collection of attributes for one SOC (soc_code, skills: list, abilities: list, knowledge: list)
   - Include provenance fields: source_type="ONET", fetched_at timestamp

3. **Create external/onet/crosswalk.py**:
   - `NOCSOCCrosswalk` class loading CSV via Polars
   - `noc_to_soc(noc_code: str) -> list[str]` - returns list of SOC codes (handles 1:N)
   - `soc_to_noc(soc_code: str) -> list[str]` - reverse lookup
   - `has_mapping(noc_code: str) -> bool`
   - `coverage_stats() -> dict` - returns mapping statistics
   - Cache lookups in dict for fast repeat access

4. **Package exports**:
   - external/__init__.py: Export models
   - external/onet/__init__.py: Export NOCSOCCrosswalk

Pattern reference: See prototype onet_adapter.py for NOC_SOC_CROSSWALK dict pattern - we're replacing hardcoded dict with CSV-based loader.
  </action>
  <verify>
```python
from jobforge.external.onet import NOCSOCCrosswalk
cw = NOCSOCCrosswalk("data/crosswalk/noc2021_onet26.csv")
assert cw.has_mapping("21211")  # Data Scientists
socs = cw.noc_to_soc("21211")
assert len(socs) >= 1
assert all(soc.count("-") == 1 for soc in socs)  # Valid SOC format XX-XXXX.XX
```
  </verify>
  <done>Crosswalk loads 1,468+ mappings, noc_to_soc returns list of SOC codes, coverage_stats shows mapping statistics</done>
</task>

<task type="auto">
  <name>Task 2: Create O*NET API client and adapter</name>
  <files>
    - src/jobforge/external/onet/client.py
    - src/jobforge/external/onet/adapter.py
    - pyproject.toml
  </files>
  <action>
1. **Add dependencies to pyproject.toml**:
   - httpx>=0.27.0 (async HTTP client)
   - tenacity>=8.2.0 (retry logic)

2. **Create onet/client.py** - O*NET Web Services v2 client:
   ```python
   ONET_BASE_URL = "https://api-v2.onetcenter.org"

   class ONetClient:
       def __init__(self, api_key: str | None = None):
           # Use ONET_API_KEY env var if not provided
           # X-API-Key header authentication

       async def get_skills(self, soc_code: str) -> list[dict]
       async def get_abilities(self, soc_code: str) -> list[dict]
       async def get_knowledge(self, soc_code: str) -> list[dict]
       async def get_all_attributes(self, soc_code: str) -> dict

       def is_available(self) -> bool  # Check if API key configured
   ```

   API endpoints (v2):
   - /online/occupations/{soc}/details/skills
   - /online/occupations/{soc}/details/abilities
   - /online/occupations/{soc}/details/knowledge

   Use tenacity for retry with exponential backoff (max 3 retries, 1s base delay).
   Handle 429 rate limit errors gracefully with longer backoff.

3. **Create onet/adapter.py** - Convert O*NET to WiQ schema:
   ```python
   ONET_CONFIDENCE = 0.5  # Per CONTEXT.md: lower than authoritative

   class ONetAdapter:
       def __init__(self, client: ONetClient, crosswalk: NOCSOCCrosswalk):
           self.client = client
           self.crosswalk = crosswalk

       async def get_attributes_for_noc(
           self, noc_code: str, attribute_types: list[str] | None = None
       ) -> list[ONetAttribute]:
           # 1. Look up SOC codes via crosswalk
           # 2. Fetch attributes for each SOC
           # 3. Convert to ONetAttribute with provenance
           # 4. Handle 1:N by aggregating across all mapped SOCs
   ```

4. **Convenience function**:
   ```python
   async def get_attributes_for_noc(
       noc_code: str,
       attribute_types: list[str] | None = None,
       crosswalk_path: str = "data/crosswalk/noc2021_onet26.csv"
   ) -> list[ONetAttribute]:
       # One-liner for simple usage
   ```

5. **Update onet/__init__.py** exports: ONetClient, ONetAdapter, get_attributes_for_noc
  </action>
  <verify>
```bash
pip install httpx tenacity
python -c "from jobforge.external.onet import ONetClient, ONetAdapter, get_attributes_for_noc"
```
Verify imports work. API calls require ONET_API_KEY (tested in Task 3).
  </verify>
  <done>O*NET client connects to API v2, adapter converts to ONetAttribute schema, retry logic handles rate limits</done>
</task>

<task type="auto">
  <name>Task 3: Create O*NET integration tests</name>
  <files>
    - tests/test_onet.py
  </files>
  <action>
Create comprehensive tests for O*NET integration:

1. **Crosswalk tests** (no API key needed):
   - test_crosswalk_loads_csv: Verify CSV loads without error
   - test_crosswalk_noc_to_soc_found: Known NOC returns SOC(s)
   - test_crosswalk_noc_to_soc_not_found: Unknown NOC returns empty list
   - test_crosswalk_handles_one_to_many: NOC with multiple SOC mappings returns all
   - test_crosswalk_coverage_stats: Returns dict with total_mappings >= 1400

2. **Client tests** (mock or skip without API key):
   - test_client_is_available_no_key: Returns False when no key
   - test_client_is_available_with_key: Returns True when key set
   - Use pytest.mark.skipif for API tests when ONET_API_KEY not set
   - test_client_get_skills_valid_soc: Returns list of skill dicts
   - test_client_handles_invalid_soc: Raises or returns empty gracefully

3. **Adapter tests** (mock API responses):
   - test_adapter_get_attributes_for_noc: Returns ONetAttribute list
   - test_adapter_no_mapping_returns_empty: Unknown NOC returns []
   - test_adapter_aggregates_multiple_socs: 1:N mapping aggregates correctly
   - test_adapter_sets_confidence: All attributes have confidence=0.5
   - test_adapter_sets_provenance: source_type="ONET", source_noc set

4. **Test fixtures**:
   - Fixture for NOCSOCCrosswalk with test data
   - Mock responses for API calls (avoid hitting real API in CI)

Use pytest parametrize for multiple NOC codes where applicable.
  </action>
  <verify>
```bash
pytest tests/test_onet.py -v
```
All tests pass. Tests that require API key skip gracefully when not set.
  </verify>
  <done>15+ tests covering crosswalk, client, and adapter. CI-safe with mocks.</done>
</task>

</tasks>

<verification>
1. **Package structure**: `from jobforge.external.onet import NOCSOCCrosswalk, ONetClient, ONetAdapter, get_attributes_for_noc`
2. **Crosswalk coverage**: `crosswalk.coverage_stats()["total_mappings"] >= 1400`
3. **Test suite**: `pytest tests/test_onet.py` passes
4. **Full suite**: `pytest` passes (no regressions)
</verification>

<success_criteria>
- NOCSOCCrosswalk loads Brookfield CSV with 1,468+ mappings
- ONetClient connects to O*NET API v2 with X-API-Key auth
- ONetAdapter converts O*NET attributes to WiQ schema with provenance
- 1:N NOC-SOC cardinality handled (aggregates attributes from all mapped SOCs)
- All attributes tagged with source_type="ONET", confidence=0.5
- Tests pass without requiring real API key (mocked)
</success_criteria>

<output>
After completion, create `.planning/phases/07-external-data-integration/07-01-SUMMARY.md`
</output>
