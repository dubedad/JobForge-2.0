---
phase: 06-imputation-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/jobforge/imputation/inheritance.py
  - src/jobforge/imputation/provenance.py
  - src/jobforge/imputation/__init__.py
  - tests/test_inheritance.py
autonomous: true

must_haves:
  truths:
    - "Job title inherits attributes from its resolved L5 unit group"
    - "Each inherited value shows provenance (source level, identifier, confidence)"
    - "L5 attributes cascade down through L6 Labels to L7 job titles"
    - "User can trigger imputation and see inherited attribute values"
  artifacts:
    - path: "src/jobforge/imputation/inheritance.py"
      provides: "Hierarchical attribute inheritance logic"
      contains: "inherit_attributes"
      exports: ["inherit_attributes_to_job_titles", "apply_imputation"]
    - path: "src/jobforge/imputation/provenance.py"
      provides: "Imputation provenance tracking utilities"
      contains: "add_imputation_provenance"
      exports: ["add_imputation_provenance", "ImputationProvenanceColumns"]
    - path: "tests/test_inheritance.py"
      provides: "Validation tests for inheritance logic"
      contains: "test_inherit"
      min_lines: 80
  key_links:
    - from: "src/jobforge/imputation/inheritance.py"
      to: "src/jobforge/imputation/resolution.py"
      via: "resolve_job_title import"
      pattern: "from.*resolution import"
    - from: "src/jobforge/imputation/inheritance.py"
      to: "data/gold/oasis_skills.parquet"
      via: "pl.scan_parquet"
      pattern: "scan_parquet.*oasis"
    - from: "src/jobforge/imputation/inheritance.py"
      to: "data/gold/job_architecture.parquet"
      via: "pl.scan_parquet"
      pattern: "scan_parquet.*job_architecture"
---

<objective>
Implement hierarchical attribute inheritance with provenance tracking

Purpose: Enable job titles (L7) to inherit attributes from their parent NOC unit group (L5) with full provenance showing which level provided each value. This completes the imputation foundation by wiring resolution to attribute data.

Output: Working inheritance system that cascades L5 attributes down to L7 job titles with confidence and provenance tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-imputation-foundation/06-CONTEXT.md
@.planning/phases/06-imputation-foundation/06-RESEARCH.md
@.planning/phases/06-imputation-foundation/06-01-SUMMARY.md
@src/jobforge/pipeline/provenance.py
@src/jobforge/ingestion/oasis.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create imputation provenance utilities</name>
  <files>
    src/jobforge/imputation/provenance.py
  </files>
  <action>
Create provenance tracking utilities specific to imputation (separate from pipeline provenance).

Create `provenance.py` with:

1. `ImputationProvenanceColumns` - Named constants for column names:
   - IMPUTATION_SOURCE_LEVEL = "_imputation_source_level"  # Literal[5, 6, 7]
   - IMPUTATION_SOURCE_ID = "_imputation_source_id"  # OASIS code or unit_group_id
   - IMPUTATION_PROVENANCE = "_imputation_provenance"  # native/inherited/imputed
   - IMPUTATION_CONFIDENCE = "_imputation_confidence"  # float 0.0-1.0
   - IMPUTATION_AT = "_imputation_at"  # datetime

2. `add_imputation_provenance(df: pl.LazyFrame, source_level: int, source_id_col: str, provenance: str, confidence: float) -> pl.LazyFrame`
   - Adds all imputation provenance columns to a DataFrame
   - source_level: 5, 6, or 7
   - source_id_col: column name containing source identifier
   - provenance: "native", "inherited", or "imputed"
   - confidence: resolution confidence score

3. `create_imputed_attribute_row(value: str, source_level: int, source_id: str, provenance: str, confidence: float) -> dict`
   - Helper for building single imputed value with provenance
   - Returns dict compatible with Polars row creation

Follow existing pattern from `src/jobforge/pipeline/provenance.py` for consistency.
  </action>
  <verify>
Run `python -c "from jobforge.imputation.provenance import add_imputation_provenance, ImputationProvenanceColumns; print('OK')"` succeeds
  </verify>
  <done>
Provenance utilities provide consistent column naming and provenance tracking for all imputed values
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement attribute inheritance logic</name>
  <files>
    src/jobforge/imputation/inheritance.py
    src/jobforge/imputation/__init__.py
  </files>
  <action>
Create inheritance logic that cascades L5 attributes down to job titles.

Create `inheritance.py` with:

1. `inherit_attributes_to_job_titles(job_arch: pl.LazyFrame, attribute_df: pl.LazyFrame, attribute_name: str, gold_path: Path | None = None) -> pl.LazyFrame`

   Join L5 attributes to job titles via unit_group_id with provenance:
   a. Resolve each job title to get confidence score (use resolve_job_title from Plan 01)
   b. Left join attribute_df to job_arch on unit_group_id
   c. Add imputation provenance columns (source_level=5, provenance="inherited")
   d. Return LazyFrame preserving laziness

   Input:
   - job_arch: Job Architecture with unit_group_id column
   - attribute_df: OASIS attribute table (e.g., oasis_skills) with unit_group_id
   - attribute_name: Name for output column prefix (e.g., "skill")
   - gold_path: Path to gold directory for resolution context

   Output columns (in addition to job_arch columns):
   - All attribute columns from attribute_df
   - _imputation_source_level (always 5 for L5 inheritance)
   - _imputation_source_id (unit_group_id)
   - _imputation_provenance ("inherited")
   - _imputation_confidence (from resolution)
   - _imputation_at (timestamp)

2. `apply_imputation(job_title: str, unit_group_id: str, attribute_tables: dict[str, pl.LazyFrame], gold_path: Path | None = None) -> dict[str, list[dict]]`

   Single job title imputation for interactive use:
   a. Resolve job title to get NOC level and confidence
   b. For each attribute table, fetch matching L5 attributes
   c. Build imputed values with full provenance
   d. Return dict mapping attribute_name -> list of ImputedValue dicts

   This function is for demo/interactive use; the batch function is for pipeline.

3. `get_imputation_summary(imputed_df: pl.LazyFrame) -> dict`

   Generate summary statistics:
   - Total rows imputed
   - Rows by source level (5/6/7)
   - Rows by provenance type (native/inherited/imputed)
   - Average confidence score

Update `__init__.py` to export:
- From models: All model classes
- From resolution: resolve_job_title, build_resolution_context, clear_resolution_cache
- From inheritance: inherit_attributes_to_job_titles, apply_imputation
- From provenance: add_imputation_provenance, ImputationProvenanceColumns

IMPORTANT: Use Polars LazyFrame throughout to preserve laziness. Only .collect() at the end when user explicitly requests materialization.
  </action>
  <verify>
Run `python -c "from jobforge.imputation import inherit_attributes_to_job_titles, apply_imputation; print('OK')"` succeeds
  </verify>
  <done>
Inheritance logic joins L5 attributes to job titles with correct provenance columns and confidence tracking
  </done>
</task>

<task type="auto">
  <name>Task 3: Create inheritance validation tests</name>
  <files>
    tests/test_inheritance.py
  </files>
  <action>
Create test suite validating inheritance behavior against requirements.

Test file structure:

1. Fixtures:
   - `gold_path` - Path to data/gold/
   - `job_arch_sample` - Sample job titles from job_architecture.parquet
   - `oasis_skills` - Load oasis_skills.parquet

2. Core inheritance tests:
   - `test_inherit_attributes_adds_provenance_columns()` - All 5 provenance columns present
   - `test_inherit_attributes_source_level_is_5()` - Verifies L5 inheritance
   - `test_inherit_attributes_preserves_job_arch_columns()` - Original columns intact
   - `test_inherit_attributes_joins_correctly()` - Matching unit_group_ids have attributes
   - `test_inherit_attributes_null_for_missing_ug()` - No attributes for unknown UG

3. Single imputation tests:
   - `test_apply_imputation_returns_dict()` - Returns dict of attribute lists
   - `test_apply_imputation_has_confidence()` - Each value has confidence score
   - `test_apply_imputation_has_source_id()` - Each value has source identifier

4. Provenance validation tests:
   - `test_provenance_inherited_for_l5_attributes()` - Provenance = "inherited"
   - `test_provenance_columns_match_spec()` - Column names match ImputationProvenanceColumns

5. Integration test:
   - `test_end_to_end_imputation()` - Load job title, impute skills, verify provenance chain

Use actual gold data for tests. Read sample unit_group_ids from element_labels to find valid test cases.

REQUIREMENT COVERAGE:
- IMP-01: Validated by comparing outputs to known prototype behavior
- IMP-02: Validated by test_inherit_attributes_source_level_is_5 and provenance tests
  </action>
  <verify>
Run `pytest tests/test_inheritance.py -v` - all tests pass
  </verify>
  <done>
Test suite validates L5->L6->L7 inheritance with provenance tracking passes
  </done>
</task>

</tasks>

<verification>
1. All imports work: `python -c "from jobforge.imputation import inherit_attributes_to_job_titles, apply_imputation, ImputationProvenanceColumns; print('OK')"`
2. Inheritance connects resolution to attributes: Job title -> resolve -> inherit L5 attributes
3. Provenance columns present: _imputation_source_level, _imputation_source_id, _imputation_provenance, _imputation_confidence, _imputation_at
4. Test suite passes: `pytest tests/test_inheritance.py -v`
5. Full test suite passes: `pytest tests/ -v`
</verification>

<success_criteria>
- [ ] Provenance utilities provide consistent column naming (_imputation_*)
- [ ] inherit_attributes_to_job_titles joins L5 attributes via unit_group_id
- [ ] Every inherited value has full provenance (source_level=5, source_id, confidence)
- [ ] apply_imputation enables single job title imputation for interactive use
- [ ] Test suite validates IMP-01 (prototype parity) and IMP-02 (hierarchical inheritance)
- [ ] All existing tests still pass (100 tests from v1.0)
</success_criteria>

<output>
After completion, create `.planning/phases/06-imputation-foundation/06-02-SUMMARY.md`
</output>
