---
phase: 16-extended-metadata
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/jobforge/external/tbs/allowances_scraper.py
  - src/jobforge/ingestion/og_allowances.py
  - data/tbs/og_allowances.json
  - data/gold/fact_og_allowances.parquet
  - data/catalog/tables/fact_og_allowances.json
  - tests/external/tbs/test_allowances_scraper.py
  - tests/ingestion/test_og_allowances.py
autonomous: true

must_haves:
  truths:
    - "User can query bilingual bonus amounts"
    - "User can query supervisory allowances"
    - "User can query isolated post allowances"
    - "Allowances linked to OG codes where applicable"
  artifacts:
    - path: "src/jobforge/external/tbs/allowances_scraper.py"
      provides: "TBS allowances scraper"
      exports: ["scrape_allowances", "Allowance"]
    - path: "src/jobforge/ingestion/og_allowances.py"
      provides: "Allowances ingestion pipeline"
      exports: ["ingest_fact_og_allowances"]
    - path: "data/gold/fact_og_allowances.parquet"
      provides: "Allowances fact table"
      min_rows: 10
    - path: "data/catalog/tables/fact_og_allowances.json"
      provides: "Catalog metadata"
      contains: "allowance_type"
  key_links:
    - from: "data/gold/fact_og_allowances.parquet"
      to: "data/gold/dim_og.parquet"
      via: "FK og_code (nullable)"
      pattern: "og_code"
---

<objective>
Create allowances scraper and fact table for TBS bilingual bonus, supervisory, and other allowances.

Purpose: Enable querying supplemental compensation beyond base pay. Per CONTEXT.md: "fact_og_allowances separate table (bilingual bonus, supervisory, isolated post, etc.)."
Output: fact_og_allowances gold table with allowance types, amounts, and eligibility criteria.
</objective>

<execution_context>
@C:\Users\Administrator\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Administrator\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-extended-metadata/16-CONTEXT.md
@.planning/phases/16-extended-metadata/16-RESEARCH.md
@src/jobforge/external/tbs/pay_rates_scraper.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TBS allowances scraper</name>
  <files>
    src/jobforge/external/tbs/allowances_scraper.py
    data/tbs/og_allowances.json
    tests/external/tbs/test_allowances_scraper.py
  </files>
  <action>
Create `src/jobforge/external/tbs/allowances_scraper.py`:

1. `Allowance` Pydantic model:
   ```python
   class Allowance(BaseModel):
       allowance_id: str  # Generated UUID
       allowance_type: str  # 'bilingual_bonus', 'supervisory', 'isolated_post', 'shift', 'standby', etc.
       allowance_name: str  # Official name from TBS

       # Amount/Rate
       amount: Decimal | None = None  # Annual amount (e.g., $800 bilingual bonus)
       rate_type: str = "annual"  # 'annual', 'hourly', 'percentage', 'per_diem'
       percentage: Decimal | None = None  # For percentage-based allowances

       # Eligibility
       og_code: str | None = None  # FK to dim_og (null if applies to all)
       classification_level: str | None = None  # e.g., "EX-01" if level-specific
       eligibility_criteria: str | None = None  # Text description

       # Temporal
       effective_date: str | None = None

       # Provenance
       source_url: str
       scraped_at: str
   ```

2. `scrape_allowances(delay: float = 1.5) -> list[Allowance]`:
   - Scrape from TBS allowances pages (bilingual bonus, supervisory, isolated post)
   - Key URLs:
     - Bilingual bonus: https://www.canada.ca/en/treasury-board-secretariat/services/pay/rates-pay/bilingual-bonus.html
     - Isolated posts: https://www.tbs-sct.canada.ca/pol/doc-eng.aspx?id=25271 (or similar)
   - Use 1.5s delay between requests
   - Extract amounts and eligibility criteria

3. `scrape_all_allowances(output_dir: Path) -> Path`:
   - Orchestrate scraping all allowance types
   - Save to data/tbs/og_allowances.json

Create tests in `tests/external/tbs/test_allowances_scraper.py`:
- Test Allowance model validation
- Test amount parsing (dollar amounts, percentages)
- Test allowance_type categorization
- Test scraper handles missing allowance pages gracefully
  </action>
  <verify>
Run: `pytest tests/external/tbs/test_allowances_scraper.py -v`
Tests pass.
Check: `python -c "import json; data = json.load(open('data/tbs/og_allowances.json')); print(f'Allowances: {len(data)}')"` (if scraping ran)
  </verify>
  <done>
Allowances scraper extracts bilingual bonus, supervisory, and isolated post allowances from TBS. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create allowances ingestion pipeline and catalog</name>
  <files>
    src/jobforge/ingestion/og_allowances.py
    data/gold/fact_og_allowances.parquet
    data/catalog/tables/fact_og_allowances.json
    tests/ingestion/test_og_allowances.py
  </files>
  <action>
Create `src/jobforge/ingestion/og_allowances.py`:

1. `ingest_fact_og_allowances()`:
   - Load from data/tbs/og_allowances.json
   - Bronze: Parse JSON, validate amounts
   - Silver: Normalize og_codes, categorize allowance_type
   - Gold: Write data/gold/fact_og_allowances.parquet

2. Schema for fact_og_allowances:
   ```python
   columns = [
       "allowance_id",          # PK
       "allowance_type",        # Category: bilingual_bonus, supervisory, isolated_post, etc.
       "allowance_name",        # Official TBS name
       "amount",                # Dollar amount (nullable)
       "rate_type",             # annual, hourly, percentage, per_diem
       "percentage",            # For percentage-based (nullable)
       "og_code",               # FK to dim_og (nullable if universal)
       "classification_level",  # Level-specific (nullable)
       "eligibility_criteria",  # Text description
       "effective_date",
       "_source_url",
       "_scraped_at",
       "_ingested_at",
       "_batch_id",
       "_layer",
   ]
   ```

Create `data/catalog/tables/fact_og_allowances.json`:
   ```json
   {
     "name": "fact_og_allowances",
     "description": "TBS allowances including bilingual bonus, supervisory allowances, isolated post differentials, and other supplemental compensation",
     "source": "Treasury Board Secretariat Compensation Directives",
     "domain": "occupational_groups",
     "layer": "gold",
     "columns": [
       {"name": "allowance_id", "type": "string", "description": "Primary key - unique allowance identifier"},
       {"name": "allowance_type", "type": "string", "description": "Category: bilingual_bonus, supervisory, isolated_post, shift, standby"},
       {"name": "allowance_name", "type": "string", "description": "Official allowance name from TBS"},
       {"name": "amount", "type": "decimal", "description": "Dollar amount (annual unless rate_type differs)"},
       {"name": "rate_type", "type": "string", "description": "Rate type: annual, hourly, percentage, per_diem"},
       {"name": "og_code", "type": "string", "description": "FK to dim_og (null if allowance applies universally)"},
       ...
     ],
     "relationships": [
       {
         "to_table": "dim_og",
         "from_column": "og_code",
         "to_column": "og_code",
         "cardinality": "many-to-one",
         "nullable": true
       }
     ]
   }
   ```

Create tests in `tests/ingestion/test_og_allowances.py`:
- Test pipeline produces parquet with expected columns
- Test amount validation (positive numbers)
- Test allowance_type normalization
- Test provenance fields
  </action>
  <verify>
Run: `pytest tests/ingestion/test_og_allowances.py -v`
Tests pass.
Check: `python -c "import polars as pl; df = pl.read_parquet('data/gold/fact_og_allowances.parquet'); print(f'Rows: {len(df)}, Types: {df[\"allowance_type\"].unique().to_list()}')"` (if data exists)
Catalog: `python -c "import json; data = json.load(open('data/catalog/tables/fact_og_allowances.json')); print(data['name'])"`
  </verify>
  <done>
fact_og_allowances.parquet created with bilingual bonus, supervisory, and other allowances. Catalog metadata complete with column descriptions and FK relationship. Tests pass.
  </done>
</task>

</tasks>

<verification>
All tasks complete when:
1. `pytest tests/external/tbs/test_allowances_scraper.py -v` - Pass
2. `pytest tests/ingestion/test_og_allowances.py -v` - Pass
3. Allowances JSON exists: `ls data/tbs/og_allowances.json`
4. Gold table exists: `ls data/gold/fact_og_allowances.parquet`
5. Catalog metadata exists: `ls data/catalog/tables/fact_og_allowances.json`
6. Multiple allowance types present (bilingual_bonus, at minimum)
</verification>

<success_criteria>
- fact_og_allowances.parquet with 10+ allowance records
- Multiple allowance_type categories (bilingual_bonus, supervisory, etc.)
- Amounts populated where TBS publishes them
- Catalog metadata complete
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/16-extended-metadata/16-04-SUMMARY.md`
</output>
