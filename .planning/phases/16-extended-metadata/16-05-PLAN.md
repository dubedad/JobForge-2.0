---
phase: 16-extended-metadata
plan: 05
type: execute
wave: 2
depends_on: ["15-02"]
files_modified:
  - src/jobforge/external/caf/training_parser.py
  - src/jobforge/ingestion/caf_training.py
  - data/caf/caf_training.json
  - data/gold/fact_caf_training.parquet
  - data/gold/dim_caf_training_location.parquet
  - data/catalog/tables/fact_caf_training.json
  - data/catalog/tables/dim_caf_training_location.json
  - tests/external/caf/test_training_parser.py
  - tests/ingestion/test_caf_training.py
autonomous: true

must_haves:
  truths:
    - "User can query CAF training requirements per occupation"
    - "User can query training duration in standardized weeks"
    - "User can query training locations with normalized names"
    - "User can query civilian credential equivalencies"
    - "Sparse data handled gracefully (not all 107 occupations have training info)"
  artifacts:
    - path: "src/jobforge/external/caf/training_parser.py"
      provides: "CAF training data parser"
      exports: ["parse_training_info", "CAFTraining", "normalize_training_location"]
    - path: "src/jobforge/ingestion/caf_training.py"
      provides: "CAF training ingestion pipeline"
      exports: ["ingest_fact_caf_training", "ingest_dim_caf_training_location"]
    - path: "data/gold/fact_caf_training.parquet"
      provides: "CAF training fact table"
      min_rows: 50
    - path: "data/gold/dim_caf_training_location.parquet"
      provides: "CAF training locations dimension"
      min_rows: 5
  key_links:
    - from: "data/gold/fact_caf_training.parquet"
      to: "data/gold/dim_caf_occupation.parquet"
      via: "FK caf_occupation_id"
      pattern: "caf_occupation_id"
    - from: "data/gold/fact_caf_training.parquet"
      to: "data/gold/dim_caf_training_location.parquet"
      via: "FK training_location_id"
      pattern: "training_location_id"
---

<objective>
Create CAF training extraction and gold tables for military occupation training requirements.

Purpose: Enable querying CAF training paths including duration, locations, certifications, and civilian equivalencies. Per CONTEXT.md: "All 107 CAF occupations included (even if training info sparse)" and "Duration: standardized weeks + original text."
Output: fact_caf_training and dim_caf_training_location gold tables with structured training data.
</objective>

<execution_context>
@C:\Users\Administrator\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Administrator\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-extended-metadata/16-CONTEXT.md
@.planning/phases/16-extended-metadata/16-RESEARCH.md
@.planning/phases/15-caf-core/15-02-PLAN.md

# Phase 15 outputs (required dependencies)
# These files must exist from Phase 15 execution:
# - src/jobforge/external/caf/scraper.py (CAF career scraper)
# - data/caf/caf_careers.json (scraped career data)
# - data/gold/dim_caf_occupation.parquet (CAF occupations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CAF training parser with location normalization</name>
  <files>
    src/jobforge/external/caf/training_parser.py
    tests/external/caf/test_training_parser.py
  </files>
  <action>
Create `src/jobforge/external/caf/training_parser.py`:

1. `CAFTraining` Pydantic model (per CONTEXT.md):
   ```python
   class CAFTraining(BaseModel):
       caf_occupation_id: str  # FK to dim_caf_occupation
       training_type: str  # 'bmq' (Basic Military Qualification) or 'occupation_specific'

       # Duration: standardized + original (CONTEXT.md)
       duration_weeks: float | None = None  # Standardized to weeks
       duration_text: str | None = None  # Original text (e.g., "10 weeks", "2.5 months")

       # Location (FK to dim_caf_training_location)
       training_location_id: str | None = None
       training_location_text: str | None = None  # Original text

       # Certifications awarded (CONTEXT.md)
       certifications_awarded: list[str] = Field(default_factory=list)
       qualifications_awarded: list[str] = Field(default_factory=list)

       # Prerequisites (CONTEXT.md)
       prerequisite_courses: list[str] = Field(default_factory=list)
       minimum_rank: str | None = None

       # Civilian equivalency (CONTEXT.md)
       civilian_credential_level: str | None = None  # Standardized: 'certificate', 'diploma', etc.
       civilian_equivalency_text: str | None = None

       # Recurring requirements (CONTEXT.md)
       recertification_required: bool = False
       recertification_frequency: str | None = None  # e.g., "annually", "every 5 years"

       # Provenance
       source_url: str | None = None
       extracted_at: str | None = None
   ```

2. `parse_training_info(career_data: dict) -> list[CAFTraining]`:
   - Extract training info from Phase 15 CAF career scraped data
   - Create separate records for BMQ and occupation-specific training
   - Parse duration to standardized weeks (handle "weeks", "months" variants)
   - Handle sparse data gracefully (many CAF pages lack training details)

3. `normalize_training_location(location_text: str | None) -> str | None`:
   - Use rapidfuzz to match to canonical location names (per RESEARCH.md Pitfall 3)
   - Canonical locations: "CFB Borden", "CFB Gagetown", "CFB Esquimalt", "CFLRS Saint-Jean-sur-Richelieu", etc.
   - Return None if no match above 80% threshold

4. `parse_duration_to_weeks(text: str | None) -> float | None`:
   - Parse "10 weeks" -> 10.0
   - Parse "2.5 months" -> 10.0 (approximate)
   - Parse "6 months" -> 26.0
   - Return None if unparseable

Create tests in `tests/external/caf/test_training_parser.py`:
- Test CAFTraining model validation
- Test duration parsing (weeks, months variants)
- Test location normalization (fuzzy matching)
- Test parse_training_info with mock career data
- Test sparse data handling (returns empty list, not error)
  </action>
  <verify>
Run: `pytest tests/external/caf/test_training_parser.py -v`
Tests pass. Parser handles various duration formats and location names.
  </verify>
  <done>
CAF training parser module exists with duration normalization to weeks and location fuzzy matching. Handles sparse CAF data gracefully. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CAF training ingestion pipeline</name>
  <files>
    src/jobforge/ingestion/caf_training.py
    data/gold/fact_caf_training.parquet
    data/gold/dim_caf_training_location.parquet
    tests/ingestion/test_caf_training.py
  </files>
  <action>
Create `src/jobforge/ingestion/caf_training.py`:

1. `ingest_dim_caf_training_location()`:
   - Extract unique training locations from parsed CAF training data
   - Generate stable training_location_id (slugified canonical name)
   - Schema: training_location_id, location_name, province, country, base_type (e.g., 'cfb', 'cflrs')
   - Output: data/gold/dim_caf_training_location.parquet

2. `ingest_fact_caf_training()`:
   - Load CAF career data from data/caf/caf_careers.json (Phase 15 output)
   - Apply parse_training_info to each career record
   - Bronze: Parse training records with structured fields
   - Silver: Normalize locations (FK to dim_caf_training_location), validate FK to dim_caf_occupation
   - Gold: Write fact_caf_training.parquet

3. Schema for fact_caf_training:
   ```python
   columns = [
       "caf_occupation_id",           # FK to dim_caf_occupation
       "training_type",               # 'bmq' or 'occupation_specific'
       "duration_weeks",              # Standardized
       "duration_text",               # Original
       "training_location_id",        # FK to dim_caf_training_location
       "training_location_text",      # Original
       "certifications_awarded",      # JSON array
       "qualifications_awarded",      # JSON array
       "prerequisite_courses",        # JSON array
       "minimum_rank",
       "civilian_credential_level",   # Standardized
       "civilian_equivalency_text",   # Original
       "recertification_required",
       "recertification_frequency",
       "_source_url",
       "_extracted_at",
       "_ingested_at",
       "_batch_id",
       "_layer",
   ]
   ```

4. Handle sparsity (per CONTEXT.md and RESEARCH.md Pitfall 3):
   - Log warning for occupations with no training info
   - Create records with has_training_info=False for missing data (optional approach)
   - Document coverage in metrics

Create tests in `tests/ingestion/test_caf_training.py`:
- Test location dimension creation
- Test training fact table schema
- Test FK to dim_caf_occupation
- Test sparse data handling
- Test duration_weeks vs duration_text consistency
  </action>
  <verify>
Run: `pytest tests/ingestion/test_caf_training.py -v`
Tests pass.
Check: `python -c "import polars as pl; df = pl.read_parquet('data/gold/fact_caf_training.parquet'); print(f'Rows: {len(df)}, Occupations: {df[\"caf_occupation_id\"].n_unique()}')"`
Expect 50-107 training records (sparsity expected per RESEARCH.md).
Check: `python -c "import polars as pl; df = pl.read_parquet('data/gold/dim_caf_training_location.parquet'); print(f'Locations: {len(df)}')"` (5+ expected)
  </verify>
  <done>
fact_caf_training.parquet and dim_caf_training_location.parquet created. Training data extracted with standardized weeks and normalized locations. Sparse data handled gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create catalog metadata for CAF training tables</name>
  <files>
    data/catalog/tables/fact_caf_training.json
    data/catalog/tables/dim_caf_training_location.json
  </files>
  <action>
Create `data/catalog/tables/fact_caf_training.json`:
   ```json
   {
     "name": "fact_caf_training",
     "description": "Canadian Armed Forces training requirements per occupation including BMQ and occupation-specific training",
     "source": "Canadian Armed Forces / forces.ca",
     "source_url": "https://forces.ca/",
     "domain": "caf_careers",
     "layer": "gold",
     "columns": [
       {"name": "caf_occupation_id", "type": "string", "description": "FK to dim_caf_occupation"},
       {"name": "training_type", "type": "string", "description": "Training type: 'bmq' or 'occupation_specific'"},
       {"name": "duration_weeks", "type": "float", "description": "Training duration standardized to weeks"},
       {"name": "duration_text", "type": "string", "description": "Original duration text from source"},
       {"name": "training_location_id", "type": "string", "description": "FK to dim_caf_training_location"},
       {"name": "certifications_awarded", "type": "json", "description": "List of certifications awarded upon completion"},
       {"name": "civilian_credential_level", "type": "string", "description": "Civilian equivalency: certificate, diploma, degree"},
       {"name": "recertification_required", "type": "boolean", "description": "Whether periodic recertification needed"},
       ...
     ],
     "relationships": [
       {
         "to_table": "dim_caf_occupation",
         "from_column": "caf_occupation_id",
         "to_column": "caf_occupation_id",
         "cardinality": "many-to-one"
       },
       {
         "to_table": "dim_caf_training_location",
         "from_column": "training_location_id",
         "to_column": "training_location_id",
         "cardinality": "many-to-one"
       }
     ]
   }
   ```

Create `data/catalog/tables/dim_caf_training_location.json`:
   ```json
   {
     "name": "dim_caf_training_location",
     "description": "Normalized Canadian Armed Forces training locations",
     "source": "Canadian Armed Forces",
     "domain": "caf_careers",
     "layer": "gold",
     "columns": [
       {"name": "training_location_id", "type": "string", "description": "Primary key - slugified location name"},
       {"name": "location_name", "type": "string", "description": "Canonical location name (e.g., CFB Borden)"},
       {"name": "province", "type": "string", "description": "Province/territory"},
       {"name": "country", "type": "string", "description": "Country (always Canada)"},
       {"name": "base_type", "type": "string", "description": "Base type: cfb, cflrs, etc."}
     ]
   }
   ```
  </action>
  <verify>
Check: `python -c "import json; print(json.load(open('data/catalog/tables/fact_caf_training.json'))['name'])"`
Check: `python -c "import json; print(json.load(open('data/catalog/tables/dim_caf_training_location.json'))['name'])"`
Both catalog files exist with proper structure.
  </verify>
  <done>
Catalog metadata created for fact_caf_training and dim_caf_training_location with column descriptions and FK relationships.
  </done>
</task>

</tasks>

<verification>
All tasks complete when:
1. `pytest tests/external/caf/test_training_parser.py -v` - Pass
2. `pytest tests/ingestion/test_caf_training.py -v` - Pass
3. fact_caf_training.parquet exists with 50+ rows
4. dim_caf_training_location.parquet exists with 5+ rows
5. Catalog metadata files exist for both tables
6. FK relationships documented
</verification>

<success_criteria>
- fact_caf_training.parquet with 50-107 training records (depends on CAF data availability)
- dim_caf_training_location.parquet with 5+ normalized locations
- Training duration standardized to weeks
- Location names normalized via fuzzy matching
- Civilian credential equivalencies mapped
- Catalog metadata complete
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/16-extended-metadata/16-05-SUMMARY.md`
</output>
