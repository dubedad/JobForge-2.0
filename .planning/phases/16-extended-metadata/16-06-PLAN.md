---
phase: 16-extended-metadata
plan: 06
type: execute
wave: 3
depends_on: ["16-01", "16-02", "16-03", "16-04", "16-05"]
files_modified:
  - src/jobforge/catalog/dmbok_tagging.py
  - src/jobforge/catalog/enrich.py
  - data/catalog/tables/dim_og_qualification_standard.json
  - data/catalog/tables/dim_og_job_evaluation_standard.json
  - data/catalog/tables/fact_og_pay_rates.json
  - data/catalog/tables/fact_og_allowances.json
  - data/catalog/tables/dim_collective_agreement.json
  - data/catalog/tables/fact_caf_training.json
  - data/catalog/tables/dim_caf_training_location.json
  - tests/catalog/test_dmbok_tagging.py
autonomous: true

must_haves:
  truths:
    - "User can query DMBOK knowledge area per table"
    - "User can query DMBOK data element type per field"
    - "User can query data steward and data owner per table"
    - "User can query refresh frequency and retention period"
    - "User can query GC security classification"
    - "All Phase 16 tables have complete governance metadata"
  artifacts:
    - path: "src/jobforge/catalog/dmbok_tagging.py"
      provides: "DMBOK field-level and table-level tagging"
      exports: ["add_dmbok_table_tags", "add_dmbok_field_tags", "DMBOK_KNOWLEDGE_AREAS", "DMBOK_DATA_ELEMENT_TYPES"]
    - path: "src/jobforge/catalog/enrich.py"
      provides: "Extended catalog enrichment with governance fields"
      exports: ["enrich_catalog", "add_governance_metadata"]
  key_links:
    - from: "src/jobforge/catalog/enrich.py"
      to: "src/jobforge/catalog/dmbok_tagging.py"
      via: "import DMBOK tagging functions"
      pattern: "from jobforge.catalog.dmbok_tagging import"
---

<objective>
Add DMBOK tagging and governance metadata to all Phase 16 tables.

Purpose: Complete DMBOK compliance per CONTEXT.md requirements: "Table-level: primary DMBOK knowledge area" and "Field-level: DMBOK data element types" plus governance fields (data_steward, refresh_frequency, security_classification, intended_consumers).
Output: All Phase 16 catalog metadata enriched with DMBOK tags and governance metadata.
</objective>

<execution_context>
@C:\Users\Administrator\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Administrator\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-extended-metadata/16-CONTEXT.md
@.planning/phases/16-extended-metadata/16-RESEARCH.md
@src/jobforge/catalog/enrich.py
@src/jobforge/governance/compliance/dama.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DMBOK tagging module</name>
  <files>
    src/jobforge/catalog/dmbok_tagging.py
    tests/catalog/test_dmbok_tagging.py
  </files>
  <action>
Create `src/jobforge/catalog/dmbok_tagging.py` per RESEARCH.md Pattern 3 and 4:

1. Table-level DMBOK knowledge areas (per CONTEXT.md):
   ```python
   DMBOK_KNOWLEDGE_AREAS = {
       # Phase 16 tables
       "dim_og_qualification_standard": "Metadata Management",  # DMBOK-7
       "dim_og_job_evaluation_standard": "Metadata Management",  # DMBOK-7
       "fact_og_pay_rates": "Reference and Master Data",        # DMBOK-9
       "fact_og_allowances": "Reference and Master Data",       # DMBOK-9
       "dim_collective_agreement": "Reference and Master Data",  # DMBOK-9
       "fact_caf_training": "Metadata Management",              # DMBOK-7
       "dim_caf_training_location": "Reference and Master Data", # DMBOK-9

       # Existing tables (extend existing mappings)
       "dim_og": "Reference and Master Data",
       "dim_og_subgroup": "Reference and Master Data",
       "dim_og_qualifications": "Metadata Management",  # Original (deprecated)
       "dim_noc": "Reference and Master Data",
       "dim_occupations": "Reference and Master Data",
   }
   ```

2. Field-level DMBOK data element types (per CONTEXT.md "Field-level: DMBOK data element types"):
   ```python
   DMBOK_DATA_ELEMENT_TYPES = {
       # Reference codes (DMBOK-9)
       "og_code": "reference_code",
       "og_subgroup_code": "reference_code",
       "classification_level": "reference_code",
       "caf_occupation_id": "reference_code",
       "training_location_id": "reference_code",
       "agreement_id": "reference_code",
       "allowance_id": "reference_code",

       # Descriptive metadata (DMBOK-7)
       "full_text": "descriptive_text",
       "education_requirement_text": "descriptive_text",
       "experience_requirement_text": "descriptive_text",
       "factor_description": "descriptive_text",
       "level_description": "descriptive_text",
       "eligibility_criteria": "descriptive_text",

       # Structured attributes (DMBOK-3)
       "min_years_experience": "numeric_attribute",
       "education_level": "categorical_attribute",
       "security_clearance": "categorical_attribute",
       "factor_points": "numeric_attribute",
       "annual_rate": "numeric_attribute",
       "duration_weeks": "numeric_attribute",

       # Boolean flags
       "has_equivalency": "boolean_flag",
       "requires_travel": "boolean_flag",
       "is_represented": "boolean_flag",
       "recertification_required": "boolean_flag",

       # Temporal data (DMBOK-4)
       "effective_date": "temporal_effective",
       "expiry_date": "temporal_expiry",
       "extracted_at": "temporal_provenance",
       "_ingested_at": "temporal_provenance",
       "_scraped_at": "temporal_provenance",

       # Provenance identifiers (DMBOK-9)
       "source_url": "provenance_identifier",
       "_source_url": "provenance_identifier",
       "_batch_id": "provenance_identifier",
   }
   ```

3. `add_dmbok_table_tags(table_metadata: dict, table_name: str) -> dict`:
   - Add dmbok_knowledge_area to table metadata
   - Default to "Data Storage and Operations" if not mapped

4. `add_dmbok_field_tags(columns: list[dict]) -> list[dict]`:
   - Add dmbok_element_type to each column
   - Default to "data_attribute" if not mapped

Create tests in `tests/catalog/test_dmbok_tagging.py`:
- Test table-level tagging for each Phase 16 table
- Test field-level tagging for known column types
- Test default handling for unknown columns
- Test all Phase 16 columns have dmbok_element_type
  </action>
  <verify>
Run: `pytest tests/catalog/test_dmbok_tagging.py -v`
Tests pass. All Phase 16 table names have DMBOK knowledge area mappings.
  </verify>
  <done>
DMBOK tagging module exists with table-level knowledge areas and field-level data element types for all Phase 16 tables. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend catalog enrichment with governance metadata</name>
  <files>
    src/jobforge/catalog/enrich.py
  </files>
  <action>
Extend existing `src/jobforge/catalog/enrich.py` to add governance metadata (per CONTEXT.md):

1. Import DMBOK tagging module:
   ```python
   from jobforge.catalog.dmbok_tagging import (
       add_dmbok_table_tags,
       add_dmbok_field_tags,
       DMBOK_KNOWLEDGE_AREAS,
   )
   ```

2. Add governance metadata function (per CONTEXT.md Governance Granularity):
   ```python
   def add_governance_metadata(table_metadata: dict, table_name: str) -> dict:
       """Add governance metadata to table catalog entry."""

       # Determine data steward by domain
       domain = table_metadata.get("domain", "")
       if domain == "occupational_groups" or table_name.startswith("dim_og") or table_name.startswith("fact_og"):
           data_steward = "OG Data Team"
           data_owner = "Treasury Board Secretariat"
       elif domain == "caf_careers" or table_name.startswith("dim_caf") or table_name.startswith("fact_caf"):
           data_steward = "CAF Data Team"
           data_owner = "Department of National Defence"
       else:
           data_steward = "Data Governance Team"
           data_owner = "JobForge"

       table_metadata["governance"] = {
           "data_steward": data_steward,
           "data_owner": data_owner,
           "refresh_frequency": "as_published",  # TBS/CAF update irregularly
           "retention_period": "indefinite",  # Historical data preserved
           "security_classification": "Unclassified",  # All public data
           "intended_consumers": ["JD Builder", "WiQ", "Public API"],
       }

       return table_metadata
   ```

3. Add data quality metrics function:
   ```python
   def add_quality_metrics(table_metadata: dict, gold_path: Path | None = None) -> dict:
       """Add data quality metrics to table catalog entry."""

       # Compute completeness if parquet exists
       completeness_pct = None
       row_count = None

       if gold_path and gold_path.exists():
           import polars as pl
           df = pl.read_parquet(gold_path)
           row_count = len(df)

           # Compute completeness as % of non-null values
           total_cells = len(df) * len(df.columns)
           non_null_cells = sum(
               len(df) - df[col].null_count() for col in df.columns
           )
           completeness_pct = round(non_null_cells / total_cells * 100, 1) if total_cells > 0 else None

       table_metadata["quality_metrics"] = {
           "completeness_pct": completeness_pct,
           "freshness_date": datetime.now(timezone.utc).isoformat(),
           "row_count": row_count,
       }

       return table_metadata
   ```

4. Update `enrich_catalog()` to include:
   - DMBOK table-level tags
   - DMBOK field-level tags for all columns
   - Governance metadata
   - Quality metrics

5. Add function to enrich Phase 16 tables specifically:
   ```python
   PHASE_16_TABLES = [
       "dim_og_qualification_standard",
       "dim_og_job_evaluation_standard",
       "fact_og_pay_rates",
       "fact_og_allowances",
       "dim_collective_agreement",
       "fact_caf_training",
       "dim_caf_training_location",
   ]

   def enrich_phase_16_tables(catalog_path: Path | None = None) -> dict:
       """Enrich Phase 16 tables with DMBOK and governance metadata."""
       # For each Phase 16 table:
       #   1. Load existing catalog JSON
       #   2. Add DMBOK table tags
       #   3. Add DMBOK field tags to all columns
       #   4. Add governance metadata
       #   5. Add quality metrics
       #   6. Write updated catalog JSON
       ...
   ```
  </action>
  <verify>
Run: `python -c "from jobforge.catalog.enrich import enrich_phase_16_tables; result = enrich_phase_16_tables(); print(result)"`
Output shows tables_updated >= 7 (all Phase 16 tables).

Check DMBOK tags added: `python -c "import json; data = json.load(open('data/catalog/tables/dim_og_qualification_standard.json')); print(data.get('dmbok_knowledge_area')); print(data['columns'][0].get('dmbok_element_type'))"`
Output shows "Metadata Management" and a valid element type.
  </verify>
  <done>
Catalog enrichment extended with DMBOK tagging (table and field level) and governance metadata (data_steward, refresh_frequency, security_classification). enrich_phase_16_tables() function available.
  </done>
</task>

<task type="auto">
  <name>Task 3: Apply DMBOK and governance enrichment to all Phase 16 catalogs</name>
  <files>
    data/catalog/tables/dim_og_qualification_standard.json
    data/catalog/tables/dim_og_job_evaluation_standard.json
    data/catalog/tables/fact_og_pay_rates.json
    data/catalog/tables/fact_og_allowances.json
    data/catalog/tables/dim_collective_agreement.json
    data/catalog/tables/fact_caf_training.json
    data/catalog/tables/dim_caf_training_location.json
  </files>
  <action>
Run enrichment on all Phase 16 catalog files:

1. Execute: `python -c "from jobforge.catalog.enrich import enrich_phase_16_tables; enrich_phase_16_tables()"`

2. Verify each catalog file has:
   - `dmbok_knowledge_area` at table level
   - `governance` object with: data_steward, data_owner, refresh_frequency, retention_period, security_classification, intended_consumers
   - `quality_metrics` object with: completeness_pct, freshness_date, row_count
   - Each column has `dmbok_element_type`

3. If any catalog file is missing (e.g., Phase 16 plans 01-05 not yet run), log warning but don't fail.

4. Generate summary report:
   ```
   Phase 16 DMBOK Enrichment Report
   ================================
   Tables enriched: 7
   Columns tagged: 120+
   Knowledge areas assigned:
     - Metadata Management: 3 tables
     - Reference and Master Data: 4 tables
   Governance metadata added to all tables
   ```

5. Validate DMBOK compliance:
   - All columns have dmbok_element_type
   - All tables have dmbok_knowledge_area
   - All tables have governance.data_steward
  </action>
  <verify>
Run validation script:
```bash
python -c "
import json
from pathlib import Path

tables = [
    'dim_og_qualification_standard',
    'dim_og_job_evaluation_standard',
    'fact_og_pay_rates',
    'fact_og_allowances',
    'dim_collective_agreement',
    'fact_caf_training',
    'dim_caf_training_location',
]

for table in tables:
    path = Path(f'data/catalog/tables/{table}.json')
    if not path.exists():
        print(f'{table}: MISSING')
        continue
    data = json.load(open(path))
    has_dmbok = 'dmbok_knowledge_area' in data
    has_gov = 'governance' in data
    fields_tagged = all('dmbok_element_type' in c for c in data.get('columns', []))
    print(f'{table}: DMBOK={has_dmbok} GOV={has_gov} FIELDS={fields_tagged}')
"
```
All tables show DMBOK=True GOV=True FIELDS=True.
  </verify>
  <done>
All Phase 16 catalog files enriched with DMBOK tags (table-level knowledge area, field-level element types) and governance metadata (data_steward, data_owner, refresh_frequency, retention_period, security_classification, intended_consumers).
  </done>
</task>

</tasks>

<verification>
All tasks complete when:
1. `pytest tests/catalog/test_dmbok_tagging.py -v` - Pass
2. DMBOK tagging module exists with knowledge areas and element types
3. Catalog enrichment extended with governance functions
4. All 7 Phase 16 catalog files have:
   - dmbok_knowledge_area (table level)
   - dmbok_element_type (field level, all columns)
   - governance object with all CONTEXT.md fields
   - quality_metrics object
</verification>

<success_criteria>
- DMBOK tagging module complete with table and field mappings
- Catalog enrichment extended with governance metadata
- All Phase 16 tables have DMBOK knowledge area assigned
- All Phase 16 columns have DMBOK element type assigned
- Governance metadata (data_steward, refresh_frequency, security_classification, intended_consumers) present on all tables
- Quality metrics computed where gold parquet exists
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/16-extended-metadata/16-06-SUMMARY.md`
</output>
