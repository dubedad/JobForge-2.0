---
phase: 18-data-quality-dashboard
plan: 06
type: execute
wave: 3
depends_on: ["18-03", "18-05"]
files_modified:
  - src/jobforge/dashboard/pages/detail.py
  - src/jobforge/dashboard/pages/compare.py
  - src/jobforge/dashboard/pages/trends.py
  - src/jobforge/dashboard/components/sparkline.py
  - src/jobforge/dashboard/export.py
  - src/jobforge/cli/commands.py
autonomous: true

must_haves:
  truths:
    - "User can view single-table detail with dimension breakdown"
    - "User can compare 2-3 tables side-by-side on radar chart"
    - "User can view quality trends over time with sparklines"
    - "User can export PDF reports and CSV data dumps"
  artifacts:
    - path: "src/jobforge/dashboard/pages/detail.py"
      provides: "Single-table drill-down page"
      contains: "radar|dimension"
    - path: "src/jobforge/dashboard/pages/compare.py"
      provides: "Side-by-side radar chart comparison (2-3 tables)"
      contains: "Scatterpolar|comparison"
    - path: "src/jobforge/dashboard/pages/trends.py"
      provides: "Historical trend analysis page"
      contains: "sparkline|history"
    - path: "src/jobforge/dashboard/export.py"
      provides: "PDF report and CSV export functions"
      exports: ["export_pdf_report", "export_csv_dump"]
  key_links:
    - from: "src/jobforge/dashboard/pages/compare.py"
      to: "src/jobforge/dashboard/components/radar.py"
      via: "Uses radar component for comparison"
      pattern: "create_radar_chart"
    - from: "src/jobforge/dashboard/pages/trends.py"
      to: "src/jobforge/quality/history.py"
      via: "Loads historical snapshots"
      pattern: "load_quality_history"
---

<objective>
Complete the dashboard with detail page, comparison view, trends analysis, and export functionality (DQ-05 complete).

Purpose: Enables deep analysis of quality issues (detail page), pattern comparison across datasets (compare page), and degradation monitoring (trends page). Export supports compliance reporting.

Output: 3 additional dashboard pages, sparkline component, PDF/CSV export, CLI dashboard command.
</objective>

<execution_context>
@C:\Users\Administrator\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Administrator\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/18-data-quality-dashboard/18-CONTEXT.md
@.planning/phases/18-data-quality-dashboard/18-RESEARCH.md

# Prior plan outputs
@.planning/phases/18-data-quality-dashboard/18-03-SUMMARY.md
@.planning/phases/18-data-quality-dashboard/18-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Detail and Compare Pages</name>
  <files>
    src/jobforge/dashboard/pages/detail.py
    src/jobforge/dashboard/pages/compare.py
  </files>
  <action>
    Create detail page (single-table drill-down):

    src/jobforge/dashboard/pages/detail.py:
    - Table selector dropdown (or use session state from summary click)
    - Header: Table name + overall score + grade badge
    - Radar chart showing 9 dimensions for selected table
    - Dimension breakdown table:
      - Column: Dimension name, Score, Weight, Weighted contribution
      - Highlight dimensions below threshold in red
    - Metadata section: Last updated, row count, catalog info
    - "Compare" button -> navigates to compare page with this table pre-selected

    Create compare page (side-by-side radar, from CONTEXT.md):

    src/jobforge/dashboard/pages/compare.py:
    - Multi-select for 2-3 tables (st.multiselect, max 3)
    - Side-by-side radar chart using create_radar_chart component
    - Comparison table below radar:
      - Rows: 9 dimensions
      - Columns: Each selected table + difference column
      - Highlight best/worst per dimension
    - Use case: Compare similar tables (e.g., all dim_ tables, all bridge_ tables)

    Page registration:
    - Add to app.py st.navigation with proper icons
    - detail: icon=":material/table_chart:"
    - compare: icon=":material/compare_arrows:"
  </action>
  <verify>
    python -c "
from jobforge.dashboard.pages.detail import render_detail_page
from jobforge.dashboard.pages.compare import render_compare_page
print('Pages OK')
"
  </verify>
  <done>Detail page shows dimension breakdown, compare page shows side-by-side radar</done>
</task>

<task type="auto">
  <name>Task 2: Trends Page and Sparkline Component</name>
  <files>
    src/jobforge/dashboard/pages/trends.py
    src/jobforge/dashboard/components/sparkline.py
  </files>
  <action>
    Create sparkline component (from RESEARCH.md Pattern 7):

    src/jobforge/dashboard/components/sparkline.py:
    - display_sparkline(scores: list[float], dates: list[str]) -> None
    - Mini Plotly line chart (80px height)
    - fill='tozeroy' for area under line
    - Minimal layout (no axes labels, no legend)
    - Hover shows date + score
    - Used in summary grid and trends page

    Create trends page (deep analysis, from CONTEXT.md):

    src/jobforge/dashboard/pages/trends.py:
    - Table selector dropdown
    - Date range selector (7d, 30d, 90d options)
    - Main chart: Line chart showing overall score over time
    - Dimension breakdown: 9 small multiples (one per dimension)
    - Degradation alerts section:
      - Call detect_degradation() from history module
      - Show alert banner if degraded
      - Display reason (threshold vs trend)
    - Statistics panel:
      - Current score, 7-day average, 30-day average
      - Min/max over period
      - Trend direction (up/down/stable)

    Add sparklines to summary page:
    - Update summary.py to show sparkline next to each traffic light
    - Use cached history data (limit to last 30 days for performance)

    Page registration:
    - Add to app.py: icon=":material/trending_up:"
  </action>
  <verify>
    python -c "
from jobforge.dashboard.components.sparkline import display_sparkline
from jobforge.dashboard.pages.trends import render_trends_page
print('Trends OK')
"
  </verify>
  <done>Trends page shows historical analysis with degradation detection, sparklines in summary</done>
</task>

<task type="auto">
  <name>Task 3: Export Functionality and CLI Dashboard Command</name>
  <files>
    src/jobforge/dashboard/export.py
    src/jobforge/cli/commands.py
    src/jobforge/dashboard/app.py
  </files>
  <action>
    Create export module (from CONTEXT.md - PDF + CSV):

    src/jobforge/dashboard/export.py:
    - export_pdf_report(tables: list[str] | None = None) -> bytes
      - Generate PDF with radar charts and dimension tables
      - Use kaleido to convert Plotly charts to images
      - Use reportlab for PDF assembly
      - Include: title, date, overall summary, per-table sections
    - export_csv_dump(tables: list[str] | None = None) -> str
      - CSV with columns: table_name, dimension, score, weight, weighted_score
      - All 39 tables if tables=None
    - export_summary_csv() -> str
      - Simple CSV: table_name, overall_score, grade

    Add export buttons to dashboard:
    - Update app.py sidebar with export section
    - "Export PDF Report" button -> calls export_pdf_report, triggers download
    - "Export CSV Data" button -> calls export_csv_dump, triggers download
    - Use st.download_button for browser download

    Add CLI dashboard command:

    Update src/jobforge/cli/commands.py:

    @app.command()
    def dashboard(
        port: int = typer.Option(8501, "--port", "-p"),
        host: str = typer.Option("127.0.0.1", "--host"),
    ):
        """Start the data quality dashboard.

        Launches Streamlit dashboard for visual quality monitoring.

        Example:
            jobforge dashboard           # Start on localhost:8501
            jobforge dashboard -p 8080   # Custom port
        """
        import subprocess
        subprocess.run([
            "streamlit", "run",
            "src/jobforge/dashboard/app.py",
            "--server.port", str(port),
            "--server.address", host,
        ])

    This provides: jobforge dashboard command to launch the UI
  </action>
  <verify>
    python -c "
from jobforge.dashboard.export import export_csv_dump
csv = export_csv_dump(['dim_noc'])
print(f'CSV lines: {len(csv.splitlines())}')
"

    # Test CLI command exists
    jobforge dashboard --help
  </verify>
  <done>PDF and CSV export working, jobforge dashboard command launches Streamlit</done>
</task>

</tasks>

<verification>
```bash
# Test export functions
python -c "
from jobforge.dashboard.export import export_csv_dump, export_summary_csv
csv = export_csv_dump(['dim_noc'])
print(f'Detail CSV: {len(csv.splitlines())} lines')
summary = export_summary_csv()
print(f'Summary CSV: {len(summary.splitlines())} lines')
"

# Test CLI dashboard command
jobforge dashboard --help

# Manual verification: Start dashboard and test all pages
jobforge dashboard
# Then in browser:
# 1. Summary page loads with traffic lights
# 2. Click table -> detail page shows
# 3. Compare page allows 2-3 table selection
# 4. Trends page shows historical chart
# 5. Export buttons download files
```
</verification>

<success_criteria>
- [ ] Detail page shows single-table dimension breakdown with radar
- [ ] Compare page shows 2-3 tables on same radar chart
- [ ] Trends page shows historical quality with degradation alerts
- [ ] Sparkline component displays mini trend charts
- [ ] export_pdf_report generates PDF with charts
- [ ] export_csv_dump generates detailed CSV
- [ ] Export buttons in dashboard trigger downloads
- [ ] jobforge dashboard CLI command launches Streamlit
- [ ] All pages registered in st.navigation with icons
</success_criteria>

<output>
After completion, create `.planning/phases/18-data-quality-dashboard/18-06-SUMMARY.md`
</output>
