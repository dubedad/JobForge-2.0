---
phase: 17-governance-compliance-framework
plan: 05
type: execute
wave: 3
depends_on: ["17-03", "17-04"]
files_modified:
  - src/jobforge/cli/commands.py
  - src/jobforge/api/routes.py
  - src/jobforge/api/governance.py
  - tests/cli/test_governance_commands.py
  - tests/api/test_governance_routes.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "CLI has governance command group with audit, policies, elements subcommands"
    - "CLI supports interactive REPL mode for governance exploration"
    - "API has /api/governance/audit, /api/governance/policies, /api/governance/elements endpoints"
    - "Queries support filtering by policy source and DAMA dimension"
  artifacts:
    - path: "src/jobforge/cli/commands.py"
      provides: "governance command group with REPL"
      contains: "governance_app"
    - path: "src/jobforge/api/governance.py"
      provides: "Governance API routes"
      exports: ["governance_router"]
    - path: "tests/cli/test_governance_commands.py"
      provides: "CLI command tests"
      min_lines: 40
  key_links:
    - from: "src/jobforge/cli/commands.py"
      to: "click_repl"
      via: "import"
      pattern: "from click_repl import"
    - from: "src/jobforge/api/governance.py"
      to: "src/jobforge/governance/policy/loader.py"
      via: "import"
      pattern: "from.*policy.*loader import"
---

<objective>
Create the governance CLI commands and API endpoints with interactive REPL mode.

Purpose: Enables users to query policy mappings, run audits, and explore governance data through both CLI and API. REPL mode supports interactive governance exploration per CONTEXT.md decisions.

Output: governance CLI command group, governance API router, REPL mode, bidirectional query endpoints.
</objective>

<execution_context>
@C:\Users\Administrator\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Administrator\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-governance-compliance-framework/17-CONTEXT.md
@.planning/phases/17-governance-compliance-framework/17-RESEARCH.md
@.planning/phases/17-governance-compliance-framework/17-03-SUMMARY.md
@.planning/phases/17-governance-compliance-framework/17-04-SUMMARY.md
@src/jobforge/cli/commands.py
@src/jobforge/api/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add click-repl dependency and create governance CLI commands</name>
  <files>pyproject.toml, src/jobforge/cli/commands.py, tests/cli/test_governance_commands.py</files>
  <action>
1. Add click-repl>=0.3.0 to pyproject.toml dependencies

2. Create governance_app Typer group in commands.py with subcommands:

governance audit [framework] [--output PATH] [--format FORMAT] [--detailed/--summary]
- framework: "dama" (default), "dadm", "all"
- format: "table" (default), "json", "markdown", "pdf"
- detailed/summary toggle for audience mode
- Runs DAMAAudit and displays/exports results
- Default: show Rich table with dimension scores

governance policies ELEMENT_PATH
- Show all policies governing the element
- Display policy source, clause ID, status, last_verified
- Use Rich table formatting

governance elements POLICY_CLAUSE
- Show all elements satisfying a policy clause
- Input format: "TBS-DSD-6.1" or "DAMA-9"
- Display element_type, element_path, compliance_status

governance repl
- Start interactive REPL mode using click-repl
- Available commands in REPL: audit, policies, elements, help, exit
- Command history persisted to ~/.jobforge/governance_history

3. Register governance_app with main app: app.add_typer(governance_app, name="governance")

Write tests using typer.testing.CliRunner:
- Test audit command output
- Test policies lookup
- Test elements lookup
- Test --help output
  </action>
  <verify>
pip install click-repl>=0.3.0
pytest tests/cli/test_governance_commands.py -v
python -c "from jobforge.cli.commands import app; print('CLI imports OK')"
  </verify>
  <done>governance CLI command group works with audit, policies, elements, repl subcommands</done>
</task>

<task type="auto">
  <name>Task 2: Create governance API routes</name>
  <files>src/jobforge/api/governance.py, src/jobforge/api/routes.py, tests/api/test_governance_routes.py</files>
  <action>
Create src/jobforge/api/governance.py with FastAPI router:

1. GET /api/governance/audit
   - Query params: framework (dama|dadm|all), scope (project|milestone|phase)
   - Returns AuditResult as JSON
   - Optional: ?format=json|summary for response format

2. GET /api/governance/audit/report
   - Query params: framework, format (json|markdown|pdf), detailed (bool)
   - For PDF: returns application/pdf with Content-Disposition: attachment
   - For others: returns appropriate content type

3. GET /api/governance/policies/{element_path:path}
   - Returns list of PolicyMapping for the element
   - Supports nested paths: /api/governance/policies/dim_noc.unit_group_id

4. GET /api/governance/elements
   - Query params: policy_source, clause_id
   - Returns list of element_paths satisfying the policy

5. GET /api/governance/mappings
   - Returns all policy mappings
   - Optional filters: ?status=compliant&source=DAMA_DMBOK&dimension=Metadata

Update src/jobforge/api/routes.py to include governance_router:
- from jobforge.api.governance import governance_router
- app.include_router(governance_router, prefix="/api/governance", tags=["governance"])

Write tests using TestClient:
- Test audit endpoint
- Test policies lookup
- Test elements lookup
- Test mappings with filters
- Test PDF generation endpoint
  </action>
  <verify>
pytest tests/api/test_governance_routes.py -v
python -c "
from fastapi.testclient import TestClient
from jobforge.api import app
client = TestClient(app)
response = client.get('/api/governance/audit')
print(f'Audit endpoint: {response.status_code}')
"
  </verify>
  <done>Governance API has audit, policies, elements, mappings endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Add DuckDB views for governance queries</name>
  <files>src/jobforge/governance/policy/views.py, tests/governance/policy/test_views.py</files>
  <action>
Create src/jobforge/governance/policy/views.py with DuckDB view creation:

1. create_governance_views(conn: duckdb.DuckDBPyConnection) -> None
   - Creates policy_mappings view from data/catalog/policy_mappings.json
   - Creates compliance_scores view (computed from policy_mappings)

2. View definitions:

policy_mappings view:
- element_type, element_path
- policy_source, clause_id, clause_text, version_date
- compliance_status, compliance_justification
- last_verified

compliance_scores view (aggregated):
- scope (table name), total_mappings, compliant_count
- compliance_percentage
- Grouped by element_path for table-level scores

3. query_policies_sql(element: str) -> str
   - Returns SQL for "what policies govern this element"

4. query_elements_sql(source: str, clause_id: str) -> str
   - Returns SQL for "what elements satisfy this policy"

Write tests:
- Views created successfully
- Queries return expected results
- Handle empty policy_mappings.json
  </action>
  <verify>
pytest tests/governance/policy/test_views.py -v
python -c "
import duckdb
from jobforge.governance.policy.views import create_governance_views
conn = duckdb.connect(':memory:')
create_governance_views(conn)
result = conn.execute('SELECT * FROM policy_mappings LIMIT 5').fetchall()
print(f'policy_mappings view has {len(result)} sample rows')
"
  </verify>
  <done>DuckDB views expose policy_mappings and compliance_scores for SQL queries</done>
</task>

</tasks>

<verification>
```bash
# All governance tests pass
pytest tests/cli/test_governance_commands.py tests/api/test_governance_routes.py tests/governance/policy/test_views.py -v

# CLI commands work
jobforge governance --help
jobforge governance audit dama --format table
jobforge governance policies dim_noc

# API works
python -c "
from fastapi.testclient import TestClient
from jobforge.api import app
client = TestClient(app)

# Audit
r = client.get('/api/governance/audit')
print(f'Audit: {r.status_code}')

# Policies for element
r = client.get('/api/governance/policies/dim_noc')
print(f'Policies for dim_noc: {r.status_code}, {len(r.json())} policies')

# Elements for policy
r = client.get('/api/governance/elements?policy_source=DAMA_DMBOK&clause_id=DAMA-9')
print(f'Elements for DAMA-9: {r.status_code}, {len(r.json())} elements')
"
```
</verification>

<success_criteria>
- click-repl added to dependencies
- governance CLI has audit, policies, elements, repl commands
- API has /audit, /policies/{element}, /elements, /mappings endpoints
- DuckDB views provide SQL access to governance data
- Bidirectional queries work (element->policies, policy->elements)
- All tests pass (expect 20+ tests)
</success_criteria>

<output>
After completion, create `.planning/phases/17-governance-compliance-framework/17-05-SUMMARY.md`
</output>
