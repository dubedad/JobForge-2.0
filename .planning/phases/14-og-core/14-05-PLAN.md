---
phase: 14-og-core
plan: 05
type: execute
wave: 2
depends_on: ["14-02"]
files_modified:
  - src/jobforge/ingestion/og_qualifications.py
  - data/gold/dim_og_qualifications.parquet
  - data/catalog/tables/dim_og_qualifications.json
  - tests/ingestion/test_og_qualifications.py
autonomous: true

must_haves:
  truths:
    - "User can query qualification standards per occupational group"
    - "Qualification data includes structured fields (education, experience) for filtering"
    - "Raw qualification text available for full-text search"
    - "All data has provenance (source PDF, extraction timestamp)"
  artifacts:
    - path: "src/jobforge/ingestion/og_qualifications.py"
      provides: "Medallion pipeline for dim_og_qualifications"
      exports: ["ingest_dim_og_qualifications"]
    - path: "data/gold/dim_og_qualifications.parquet"
      provides: "Qualification standards dimension table"
    - path: "data/catalog/tables/dim_og_qualifications.json"
      provides: "Catalog metadata for qualifications"
  key_links:
    - from: "data/gold/dim_og_qualifications.parquet"
      to: "data/gold/dim_og.parquet"
      via: "og_code foreign key"
      pattern: "og_code"
---

<objective>
Create dim_og_qualifications gold table from extracted PDF text.

Purpose: Per CONTEXT.md, enable queries like "find OGs requiring Master's degree" by creating structured qualification fields plus raw text for full-text search. This is a key differentiator for JD Builder Lite.

Output: Ingestion pipeline, dim_og_qualifications parquet table, catalog metadata.
</objective>

<execution_context>
@C:\Users\Administrator\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Administrator\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-og-core/14-CONTEXT.md
@.planning/phases/14-og-core/14-RESEARCH.md

# Prior plan output
# Note: 14-02-SUMMARY.md will contain PDF extraction results

# Existing patterns
@src/jobforge/ingestion/noc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create qualification text parser</name>
  <files>
    src/jobforge/ingestion/og_qualifications.py
  </files>
  <action>
Create `src/jobforge/ingestion/og_qualifications.py` with qualification parsing:

1. **QualificationFields** structured extraction:
   - Parse extracted PDF text to identify structured fields
   - Common TBS qualification standard sections:
     - "Education" / "Education minimum"
     - "Experience" / "Experience equivalent"
     - "Occupational Certification" / "Professional Certification"
     - "Language Requirements"
     - "Security Clearance"

2. **parse_qualification_text()** function:
   ```python
   def parse_qualification_text(full_text: str) -> dict:
       """Extract structured fields from qualification standard text.

       Uses regex patterns to identify common TBS sections.
       Returns dict with structured fields + raw text.
       """
       fields = {
           "education_requirement": None,
           "experience_requirement": None,
           "certification_requirement": None,
           "language_requirement": None,
           "other_requirements": None,
           "full_text": full_text,  # Always preserve raw text
       }

       # Pattern matching for sections
       # Education section typically starts with "Education" and ends at next section
       education_match = re.search(
           r"(?:Education|EDUCATION)[:\s]*(.+?)(?=Experience|EXPERIENCE|Certification|$)",
           full_text, re.DOTALL | re.IGNORECASE
       )
       if education_match:
           fields["education_requirement"] = education_match.group(1).strip()[:2000]

       # Similar for other sections...
       return fields
   ```

3. Handle variability in PDF structures:
   - Some PDFs may not have clear section headers
   - Some may use different terminology
   - Log warnings when expected sections not found
   - Always preserve full_text for manual review / full-text search
  </action>
  <verify>
    `python -c "from jobforge.ingestion.og_qualifications import parse_qualification_text; print('Function imported')"`
  </verify>
  <done>parse_qualification_text extracts structured fields from PDF text while preserving raw text</done>
</task>

<task type="auto">
  <name>Task 2: Create dim_og_qualifications ingestion pipeline</name>
  <files>
    src/jobforge/ingestion/og_qualifications.py
    data/gold/dim_og_qualifications.parquet
  </files>
  <action>
Add `ingest_dim_og_qualifications()` to `src/jobforge/ingestion/og_qualifications.py`:

1. **Load extracted PDF text**:
   ```python
   with open("data/tbs/og_qualification_text.json") as f:
       extracted = json.load(f)
   ```

2. **Transform to records**:
   - For each extracted PDF, call parse_qualification_text()
   - Build record with:
     - og_code (from filename)
     - og_subgroup_code (if subgroup-specific, else None)
     - education_requirement
     - experience_requirement
     - certification_requirement
     - language_requirement
     - other_requirements
     - full_text (raw PDF text, truncated to 50000 chars max)
     - page_count
     - source_url (original PDF URL)
     - source_file (PDF filename)
     - extracted_at

3. **Bronze schema**:
   ```python
   bronze_schema = {
       "cast": {
           "og_code": pl.Utf8,
           "og_subgroup_code": pl.Utf8,
           "education_requirement": pl.Utf8,
           "experience_requirement": pl.Utf8,
           "certification_requirement": pl.Utf8,
           "language_requirement": pl.Utf8,
           "other_requirements": pl.Utf8,
           "full_text": pl.Utf8,
           "page_count": pl.Int32,
       }
   }
   ```

4. **Silver transforms**:
   - `normalize_codes`: Uppercase og_code
   - `validate_og_exists`: Ensure og_code exists in dim_og

5. **Gold transforms**:
   - `select_dim_og_qualifications_columns`: Final schema

Run pipeline using PipelineEngine.
  </action>
  <verify>
    `python -c "from jobforge.ingestion.og_qualifications import ingest_dim_og_qualifications; print('Function imported')"`
    `python -c "from jobforge.ingestion.og_qualifications import ingest_dim_og_qualifications; r = ingest_dim_og_qualifications(); print(f'Rows: {r[\"row_count\"]}')"` shows row count
  </verify>
  <done>ingest_dim_og_qualifications creates dim_og_qualifications.parquet with structured and raw qualification data</done>
</task>

<task type="auto">
  <name>Task 3: Create catalog metadata and tests</name>
  <files>
    data/catalog/tables/dim_og_qualifications.json
    tests/ingestion/test_og_qualifications.py
  </files>
  <action>
**Create catalog metadata** `data/catalog/tables/dim_og_qualifications.json`:
```json
{
  "table_name": "dim_og_qualifications",
  "domain": "occupational_groups",
  "description": "TBS Qualification Standards - education, experience, and certification requirements per occupational group",
  "source": "Treasury Board Secretariat",
  "source_url": "https://www.canada.ca/en/treasury-board-secretariat/services/staffing/qualification-standards.html",
  "columns": {
    "og_code": {"type": "VARCHAR", "description": "Occupational group code", "foreign_key": "dim_og.og_code"},
    "og_subgroup_code": {"type": "VARCHAR", "description": "Subgroup code if subgroup-specific qualification", "foreign_key": "dim_og_subgroup.og_subgroup_code"},
    "education_requirement": {"type": "VARCHAR", "description": "Minimum education requirements (extracted)"},
    "experience_requirement": {"type": "VARCHAR", "description": "Experience requirements (extracted)"},
    "certification_requirement": {"type": "VARCHAR", "description": "Professional/occupational certification requirements"},
    "language_requirement": {"type": "VARCHAR", "description": "Official language requirements"},
    "other_requirements": {"type": "VARCHAR", "description": "Other qualification requirements"},
    "full_text": {"type": "VARCHAR", "description": "Complete qualification standard text for full-text search"},
    "page_count": {"type": "INTEGER", "description": "Number of pages in source PDF"}
  },
  "relationships": [
    {"table": "dim_og", "join": "dim_og_qualifications.og_code = dim_og.og_code", "type": "many-to-one"},
    {"table": "dim_og_subgroup", "join": "dim_og_qualifications.og_subgroup_code = dim_og_subgroup.og_subgroup_code", "type": "many-to-one"}
  ],
  "usage_hints": [
    "Use education_requirement for filtering by education level",
    "Use full_text for full-text search queries",
    "Some OGs have group-level standards (og_subgroup_code is NULL), others have subgroup-specific"
  ]
}
```

**Add tests** in `tests/ingestion/test_og_qualifications.py`:
- Test parse_qualification_text extracts education section
- Test parse_qualification_text preserves full_text
- Test ingest_dim_og_qualifications produces rows
- Test FK integrity (og_codes exist in dim_og)
- Test provenance columns exist
- Test full_text is not empty
  </action>
  <verify>
    `pytest tests/ingestion/test_og_qualifications.py -v` passes
    `ls -la data/catalog/tables/dim_og_qualifications.json` shows file exists
    `python -c "import polars as pl; df=pl.read_parquet('data/gold/dim_og_qualifications.parquet'); print(df.select(['og_code','education_requirement']).head())"` shows data
  </verify>
  <done>Catalog metadata created; tests pass; dim_og_qualifications queryable with structured fields and full_text</done>
</task>

</tasks>

<verification>
1. `pytest tests/ingestion/test_og_qualifications.py -v` - all tests pass
2. `python -c "import polars as pl; print(pl.read_parquet('data/gold/dim_og_qualifications.parquet').shape)"` - shows row count
3. Structured fields (education_requirement, etc.) populated where extraction succeeded
4. full_text column available for full-text search
5. Provenance columns present
</verification>

<success_criteria>
- parse_qualification_text extracts structured fields from PDF text
- ingest_dim_og_qualifications creates dim_og_qualifications.parquet
- Structured fields populated where possible (education, experience, etc.)
- full_text preserved for all records (full-text search capability)
- FK to dim_og validated
- Catalog metadata file created
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-og-core/14-05-SUMMARY.md`
</output>
